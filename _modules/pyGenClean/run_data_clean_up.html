<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyGenClean.run_data_clean_up &mdash; pyGenClean 1.8.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.8.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pyGenClean 1.8.1 documentation" href="../../index.html" />
    <link rel="up" title="pyGenClean" href="../pyGenClean.html" /> 
  </head>
  <body role="document">

<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
<a href="../../index.html"><img src="../../_static/logo.png" border="0" alt="py4sci"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyGenClean 1.8.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../pyGenClean.html" accesskey="U">pyGenClean</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyGenClean.run_data_clean_up</h1><div class="highlight"><pre>
<span class="ch">#!/usr/bin/env python2.7</span>

<span class="c1"># This file is part of pyGenClean.</span>
<span class="c1">#</span>
<span class="c1"># pyGenClean is free software: you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU General Public License as published by the Free Software</span>
<span class="c1"># Foundation, either version 3 of the License, or (at your option) any later</span>
<span class="c1"># version.</span>
<span class="c1">#</span>
<span class="c1"># pyGenClean is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="c1"># WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR</span>
<span class="c1"># A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License along with</span>
<span class="c1"># pyGenClean.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">add_file_handler_to_root</span>

<span class="kn">from</span> <span class="nn">.pipeline_error</span> <span class="kn">import</span> <span class="n">ProgramError</span>

<span class="kn">from</span> <span class="nn">.FlagHW</span> <span class="kn">import</span> <span class="n">flag_hw</span>
<span class="kn">from</span> <span class="nn">.SexCheck</span> <span class="kn">import</span> <span class="n">sex_check</span>
<span class="kn">from</span> <span class="nn">.PlateBias</span> <span class="kn">import</span> <span class="n">plate_bias</span>
<span class="kn">from</span> <span class="nn">.FlagMAF</span> <span class="kn">import</span> <span class="n">flag_maf_zero</span>
<span class="kn">from</span> <span class="nn">.DupSNPs</span> <span class="kn">import</span> <span class="n">duplicated_snps</span>
<span class="kn">from</span> <span class="nn">.Ethnicity</span> <span class="kn">import</span> <span class="n">check_ethnicity</span>
<span class="kn">from</span> <span class="nn">.Misc</span> <span class="kn">import</span> <span class="n">compare_gold_standard</span>
<span class="kn">from</span> <span class="nn">.Contamination</span> <span class="kn">import</span> <span class="n">contamination</span>
<span class="kn">from</span> <span class="nn">.DupSamples</span> <span class="kn">import</span> <span class="n">duplicated_samples</span>
<span class="kn">from</span> <span class="nn">.MarkerMissingness</span> <span class="kn">import</span> <span class="n">snp_missingness</span>
<span class="kn">from</span> <span class="nn">.RelatedSamples</span> <span class="kn">import</span> <span class="n">find_related_samples</span>
<span class="kn">from</span> <span class="nn">.SampleMissingness</span> <span class="kn">import</span> <span class="n">sample_missingness</span>
<span class="kn">from</span> <span class="nn">.HeteroHap</span> <span class="kn">import</span> <span class="n">remove_heterozygous_haploid</span>
<span class="kn">from</span> <span class="nn">.NoCallHetero</span> <span class="kn">import</span> <span class="n">clean_noCall_hetero_snps</span> <span class="k">as</span> <span class="n">noCall_hetero_snps</span>

<span class="kn">from</span> <span class="nn">.LaTeX</span> <span class="kn">import</span> <span class="n">auto_report</span>
<span class="kn">from</span> <span class="nn">.LaTeX</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">latex_template</span>
<span class="kn">from</span> <span class="nn">.LaTeX.merge_reports</span> <span class="kn">import</span> <span class="n">add_custom_options</span> <span class="k">as</span> <span class="n">report_options</span>

<span class="kn">from</span> <span class="nn">.PlinkUtils</span> <span class="kn">import</span> <span class="n">subset_data</span>
<span class="kn">from</span> <span class="nn">.PlinkUtils</span> <span class="kn">import</span> <span class="n">get_plink_version</span>
<span class="kn">from</span> <span class="nn">.PlinkUtils</span> <span class="kn">import</span> <span class="n">createRowFromPlinkSpacedOutput</span>


<span class="c1"># Configuring logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;pyGenClean&quot;</span><span class="p">)</span>


<span class="c1"># A namedtuple that will represent what each steps returns</span>
<span class="n">_StepResult</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;_StepResult&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;next_file&quot;</span><span class="p">,</span> <span class="s2">&quot;next_file_type&quot;</span><span class="p">,</span> <span class="s2">&quot;latex_summary&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span>
     <span class="s2">&quot;long_description&quot;</span><span class="p">,</span> <span class="s2">&quot;graph_path&quot;</span><span class="p">],</span>
<span class="p">)</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The main function.</span>

<span class="sd">    These are the steps performed for the data clean up:</span>

<span class="sd">    1. Prints the version number.</span>
<span class="sd">    2. Reads the configuration file (:py:func:`read_config_file`).</span>
<span class="sd">    3. Creates a new directory with ``data_clean_up`` as prefix and the date</span>
<span class="sd">       and time as suffix.</span>
<span class="sd">    4. Check the input file type (``bfile``, ``tfile`` or ``file``).</span>
<span class="sd">    5. Creates an intermediate directory with the section as prefix and the</span>
<span class="sd">       script name as suffix (inside the previous directory).</span>
<span class="sd">    6. Runs the required script in order (according to the configuration file</span>
<span class="sd">       section).</span>

<span class="sd">    .. note::</span>
<span class="sd">        The main function is not responsible to check if the required files</span>
<span class="sd">        exist. This should be done in the ``run`` functions.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Getting and checking the options</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">check_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># The directory name</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="s2">&quot;data_clean_up.&quot;</span>
    <span class="n">dirname</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H.%M.%S&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="s2">&quot;data_clean_up.&quot;</span>
        <span class="n">dirname</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H.%M.%S&quot;</span><span class="p">)</span>

    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>

    <span class="c1"># Configuring the root logger</span>
    <span class="n">add_file_handler_to_root</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;pyGenClean.log&quot;</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pyGenClean version {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">))</span>
    <span class="n">plink_version</span> <span class="o">=</span> <span class="n">get_plink_version</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using Plink version {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plink_version</span><span class="p">))</span>

    <span class="c1"># Reading the configuration file</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading configuration file [ {} ]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">conf</span><span class="p">))</span>
    <span class="n">order</span><span class="p">,</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">read_config_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>

    <span class="c1"># Executing the data clean up</span>
    <span class="n">current_in</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">current_in_type</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">suffixes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">current_in</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tfile</span>
        <span class="n">current_in_type</span> <span class="o">=</span> <span class="s2">&quot;tfile&quot;</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;.tped&quot;</span><span class="p">,</span> <span class="s2">&quot;.tfam&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">bfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">current_in</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">bfile</span>
        <span class="n">current_in_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;.bed&quot;</span><span class="p">,</span> <span class="s2">&quot;.bim&quot;</span><span class="p">,</span> <span class="s2">&quot;.fam&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current_in</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span>
        <span class="n">current_in_type</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;.ped&quot;</span><span class="p">,</span> <span class="s2">&quot;.map&quot;</span><span class="p">)</span>

    <span class="c1"># Creating the excluded files</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;excluded_markers.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_f</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;excluded_samples.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_f</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;initial_files.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">current_in</span> <span class="o">+</span> <span class="n">s</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Counting the number of markers and samples in the datafile</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Counting initial number of samples and markers&quot;</span><span class="p">)</span>
    <span class="n">nb_markers</span><span class="p">,</span> <span class="n">nb_samples</span> <span class="o">=</span> <span class="n">count_markers_samples</span><span class="p">(</span><span class="n">current_in</span><span class="p">,</span>
                                                   <span class="n">current_in_type</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - {:,d} samples&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_samples</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - {:,d} markers&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_markers</span><span class="p">))</span>

    <span class="c1"># Creating the result summary file containing the initial numbers</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# initial&quot;</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Initial number of markers</span><span class="se">\t</span><span class="s2">&quot;</span>
                             <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_markers</span><span class="p">))</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Initial number of samples</span><span class="se">\t</span><span class="s2">&quot;</span>
                             <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_samples</span><span class="p">))</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">latex_summaries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">long_descriptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">graphic_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
        <span class="c1"># Getting the script name and its options</span>
        <span class="n">script_name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="n">number</span><span class="p">]</span>

        <span class="c1"># Getting the output prefix</span>
        <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span>
                                     <span class="s2">&quot;{}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">script_name</span><span class="p">))</span>

        <span class="c1"># Getting the function to use</span>
        <span class="n">function_to_use</span> <span class="o">=</span> <span class="n">available_functions</span><span class="p">[</span><span class="n">script_name</span><span class="p">]</span>

        <span class="c1"># Executing the function</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running {} {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">script_name</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - Using {} as prefix for input &quot;</span>
                    <span class="s2">&quot;files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_in</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - Results will be in [ {} ]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_prefix</span><span class="p">))</span>

        <span class="c1"># Executing the function</span>
        <span class="n">step_results</span> <span class="o">=</span> <span class="n">function_to_use</span><span class="p">(</span>
            <span class="n">in_prefix</span><span class="o">=</span><span class="n">current_in</span><span class="p">,</span>
            <span class="n">in_type</span><span class="o">=</span><span class="n">current_in_type</span><span class="p">,</span>
            <span class="n">out_prefix</span><span class="o">=</span><span class="n">output_prefix</span><span class="p">,</span>
            <span class="n">base_dir</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Updating the input files and input file types</span>
        <span class="n">current_in</span> <span class="o">=</span> <span class="n">step_results</span><span class="o">.</span><span class="n">next_file</span>
        <span class="n">current_in_type</span> <span class="o">=</span> <span class="n">step_results</span><span class="o">.</span><span class="n">next_file_type</span>

        <span class="c1"># Saving what&#39;s necessary for the LaTeX report</span>
        <span class="n">latex_summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_results</span><span class="o">.</span><span class="n">latex_summary</span><span class="p">)</span>
        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">script_name</span><span class="p">)</span>
        <span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_results</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="n">long_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_results</span><span class="o">.</span><span class="n">long_description</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">step_results</span><span class="o">.</span><span class="n">graph_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">graphic_paths</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">step_results</span><span class="o">.</span><span class="n">graph_path</span><span class="p">)</span>

    <span class="c1"># Counting the final number of samples and markers</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Counting final number of samples and markers&quot;</span><span class="p">)</span>
    <span class="n">nb_markers</span><span class="p">,</span> <span class="n">nb_samples</span> <span class="o">=</span> <span class="n">count_markers_samples</span><span class="p">(</span><span class="n">current_in</span><span class="p">,</span>
                                                   <span class="n">current_in_type</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - {:,d} samples&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_samples</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - {:,d} markers&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_markers</span><span class="p">))</span>

    <span class="c1"># Getting the final suffixes</span>
    <span class="n">suffixes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">current_in_type</span> <span class="o">==</span> <span class="s2">&quot;tfile&quot;</span><span class="p">:</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;.tped&quot;</span><span class="p">,</span> <span class="n">nb_markers</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;.tfam&quot;</span><span class="p">,</span> <span class="n">nb_samples</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">current_in_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;.bed&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;.bim&quot;</span><span class="p">,</span> <span class="n">nb_markers</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;.fam&quot;</span><span class="p">,</span> <span class="n">nb_samples</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;.ped&quot;</span><span class="p">,</span> <span class="n">nb_samples</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;.map&quot;</span><span class="p">,</span> <span class="n">nb_markers</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;final_files.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nb</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">current_in</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">current_in</span> <span class="o">+</span> <span class="n">s</span>

    <span class="c1"># Generating the graphics paths file</span>
    <span class="n">graphic_paths_fn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphic_paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">graphic_paths_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;graphic_paths.txt&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">graphic_paths_fn</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">graphic_paths</span><span class="p">):</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">path</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We create the automatic report</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating automatic report&quot;</span><span class="p">)</span>
    <span class="n">report_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;automatic_report.tex&quot;</span><span class="p">)</span>
    <span class="n">auto_report</span><span class="o">.</span><span class="n">create_report</span><span class="p">(</span>
        <span class="n">dirname</span><span class="p">,</span>
        <span class="n">report_name</span><span class="p">,</span>
        <span class="n">project_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">report_number</span><span class="p">,</span>
        <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
        <span class="n">descriptions</span><span class="o">=</span><span class="n">descriptions</span><span class="p">,</span>
        <span class="n">graphic_paths_fn</span><span class="o">=</span><span class="n">graphic_paths_fn</span><span class="p">,</span>
        <span class="n">long_descriptions</span><span class="o">=</span><span class="n">long_descriptions</span><span class="p">,</span>
        <span class="n">summaries</span><span class="o">=</span><span class="n">latex_summaries</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">report_background</span><span class="p">,</span>
        <span class="n">summary_fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span>
        <span class="n">report_title</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">report_title</span><span class="p">,</span>
        <span class="n">report_author</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">report_author</span><span class="p">,</span>
        <span class="n">initial_files</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;initial_files.txt&quot;</span><span class="p">),</span>
        <span class="n">final_files</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="s2">&quot;final_files.txt&quot;</span><span class="p">),</span>
        <span class="n">final_nb_markers</span><span class="o">=</span><span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_markers</span><span class="p">),</span>
        <span class="n">final_nb_samples</span><span class="o">=</span><span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_samples</span><span class="p">),</span>
        <span class="n">plink_version</span><span class="o">=</span><span class="n">plink_version</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_duplicated_samples"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_duplicated_samples">[docs]</a><span class="k">def</span> <span class="nf">run_duplicated_samples</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step1 (duplicated samples).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``tfile``).</span>

<span class="sd">    This function calls the :py:mod:`pyGenClean.DupSamples.duplicated_samples`</span>
<span class="sd">    module. The required file type for this module is ``tfile``, hence the need</span>
<span class="sd">    to use the :py:func:`check_input_files` to check if the file input file</span>
<span class="sd">    type is the good one, or to create it if needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need tfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;tfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;dup_samples&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">duplicated_samples</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">duplicated_samples</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;duplicated_samples: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Reading the number of duplicated samples</span>
    <span class="n">duplicated_count</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.duplicated_samples.tfam&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.duplicated_samples.tfam&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">duplicated_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">line</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span>
            <span class="p">])</span>

    <span class="c1"># Counting the number of zeroed out genotypes per duplicated sample</span>
    <span class="n">zeroed_out</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.zeroed_out&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.zeroed_out&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">zeroed_out</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">])</span>
    <span class="n">nb_zeroed_out</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">zeroed_out</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Checking the not good enough samples</span>
    <span class="n">not_good_enough</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.not_good_enough&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.not_good_enough&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">not_good_enough</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">}</span>

    <span class="c1"># Checking which samples were chosen</span>
    <span class="n">chosen_sample</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chosen_samples.info&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chosen_samples.info&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">chosen_sample</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">}</span>

    <span class="c1"># Finding if some &#39;not_good_enough&#39; samples were chosen</span>
    <span class="n">not_good_still</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">chosen_sample</span> <span class="o">&amp;</span> <span class="n">not_good_enough</span><span class="p">}</span>

    <span class="c1"># We create a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">duplicated_samples</span><span class="o">.</span><span class="n">pretty_name</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;A total of {:,d} duplicated sample{} {} found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">),</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;While merging duplicates, a total of {:,d} genotype{} {} &quot;</span>
                    <span class="s2">&quot;zeroed out. A total of {:,d} sample{} {} found to be not &quot;</span>
                    <span class="s2">&quot;good enough for duplicate completion.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_zeroed_out</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_zeroed_out</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">nb_zeroed_out</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">not_good_enough</span><span class="p">),</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_enough</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_enough</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="n">table_label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_&quot;</span><span class="p">,</span>
                    <span class="n">script_prefix</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_dup_samples&quot;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Table~\ref{&quot;</span> <span class="o">+</span> <span class="n">table_label</span> <span class="o">+</span> <span class="s2">&quot;} summarizes the number &quot;</span>
                    <span class="s2">&quot;of each duplicated sample with some characteristics.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">textbf</span><span class="p">(</span>
                        <span class="s2">&quot;There {} {:,d} sample{} that {} not good due to low &quot;</span>
                        <span class="s2">&quot;completion or concordance, but {} still selected as &quot;</span>
                        <span class="s2">&quot;the best duplicate (see Table~{}).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">),</span>
                            <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                            <span class="s2">r&quot;~\ref{&quot;</span> <span class="o">+</span> <span class="n">table_label</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="c1"># Getting the template</span>
                <span class="n">longtable_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;longtable_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># The table caption</span>
                <span class="n">table_caption</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Summary of the {:,d} duplicated sample{}. The number of &quot;</span>
                    <span class="s2">&quot;duplicates and the total number of zeroed out genotypes &quot;</span>
                    <span class="s2">&quot;are shown.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">),</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">table_caption</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">&quot; A total of {:,d} sample{} (highlighted) {} not good &quot;</span>
                        <span class="s2">&quot;enough for completion, but {} chosen as the best &quot;</span>
                        <span class="s2">&quot;duplicate, and {} still in the final &quot;</span>
                        <span class="s2">&quot;dataset).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">),</span>
                            <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;are&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">duplicated_samples_list</span> <span class="o">=</span> <span class="n">duplicated_count</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">longtable_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">table_caption</span><span class="o">=</span><span class="n">table_caption</span><span class="p">,</span>
                    <span class="n">table_label</span><span class="o">=</span><span class="n">table_label</span><span class="p">,</span>
                    <span class="n">nb_col</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                    <span class="n">col_alignments</span><span class="o">=</span><span class="s2">&quot;llrr&quot;</span><span class="p">,</span>
                    <span class="n">text_size</span><span class="o">=</span><span class="s2">&quot;scriptsize&quot;</span><span class="p">,</span>
                    <span class="n">header_data</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;FID&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;IID&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Nb Duplicate&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                 <span class="p">(</span><span class="s2">&quot;Nb Zeroed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
                    <span class="n">tabular_data</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">[</span><span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">fid</span><span class="p">),</span>
                         <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">iid</span><span class="p">),</span>
                         <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb</span><span class="p">),</span>
                         <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zeroed_out</span><span class="p">[(</span><span class="n">fid</span><span class="p">,</span> <span class="n">iid</span><span class="p">)])]</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">iid</span><span class="p">),</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">duplicated_samples_list</span>
                    <span class="p">],</span>
                    <span class="n">highlighted</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">iid</span><span class="p">)</span> <span class="ow">in</span> <span class="n">not_good_still</span>
                        <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">iid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">duplicated_samples_list</span><span class="p">]</span>
                    <span class="p">],</span>
                <span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">duplicated_count</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">counter</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;Number of replicated samples&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;Number of replicated samples</span><span class="se">\t</span><span class="s2">0&quot;</span>
        <span class="k">for</span> <span class="n">rep_type</span><span class="p">,</span> <span class="n">rep_count</span> <span class="ow">in</span> <span class="n">counter</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;  - x{}</span><span class="se">\t</span><span class="s2">{:,d}</span><span class="se">\t\t</span><span class="s2">-{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rep_type</span><span class="p">,</span>
                <span class="n">rep_count</span><span class="p">,</span>
                <span class="p">(</span><span class="n">rep_count</span> <span class="o">*</span> <span class="n">rep_type</span><span class="p">)</span> <span class="o">-</span> <span class="n">rep_count</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Poorly chosen replicated &quot;</span>
                         <span class="s2">&quot;samples</span><span class="se">\t</span><span class="s2">{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step does produce a new data set (tfile), so we return it</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;dup_samples.final&quot;</span><span class="p">),</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="s2">&quot;tfile&quot;</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">duplicated_samples</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">duplicated_samples</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_duplicated_snps"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_duplicated_snps">[docs]</a><span class="k">def</span> <span class="nf">run_duplicated_snps</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step2 (duplicated snps).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``tfile``).</span>

<span class="sd">    This function calls the :py:mod:`pyGenClean.DupSNPs.duplicated_snps`</span>
<span class="sd">    module. The required file type for this module is ``tfile``, hence the need</span>
<span class="sd">    to use the :py:func:`check_input_files` to check if the file input file</span>
<span class="sd">    type is the good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        This function creates a ``map`` file, needed for the</span>
<span class="sd">        :py:mod:`pyGenClean.DupSNPs.duplicated_snps` module.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need a tfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;tfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># This step require a map file (we now have a tfile)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">in_prefix</span> <span class="o">+</span> <span class="s2">&quot;.map&quot;</span><span class="p">):</span>
        <span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">outputFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_prefix</span> <span class="o">+</span> <span class="s2">&quot;.map&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: can&#39;t write file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_prefix</span> <span class="o">+</span> <span class="s2">&quot;.map&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_prefix</span> <span class="o">+</span> <span class="s2">&quot;.tped&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputFile</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">inputFile</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">outputFile</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no such file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_prefix</span> <span class="o">+</span> <span class="s2">&quot;.tped&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">outputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;dup_snps&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">duplicated_snps</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">duplicated_snps</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;duplicated_snps: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Reading the number of duplicated markers</span>
    <span class="n">duplicated_count</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.duplicated_snps.tped&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.duplicated_snps.tped&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">duplicated_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="nb">tuple</span><span class="p">(</span><span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">line</span><span class="p">)[:</span><span class="mi">4</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="c1"># Counting the number of zeroed out genotypes per duplicated markers</span>
    <span class="n">zeroed_out</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.zeroed_out&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.zeroed_out&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">zeroed_out</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">])</span>
    <span class="n">nb_zeroed_out</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">zeroed_out</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Checking the not good enough markers</span>
    <span class="n">not_good_enough</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.not_good_enough&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.not_good_enough&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">not_good_enough</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">}</span>

    <span class="c1"># Checking which markers were chosen</span>
    <span class="n">chosen_markers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chosen_snps.info&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chosen_snps.info&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">chosen_markers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

    <span class="c1"># Finding if some &#39;not_good_enough&#39; samples were chosen</span>
    <span class="n">not_good_still</span> <span class="o">=</span> <span class="n">chosen_markers</span> <span class="o">&amp;</span> <span class="n">not_good_enough</span>

    <span class="c1"># Adding the &#39;not chosen markers&#39; to the list of excluded markers</span>
    <span class="n">removed_markers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">o_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;excluded_markers.txt&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.removed_duplicates&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.removed_duplicates&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">removed_markers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">o_filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">marker_id</span> <span class="ow">in</span> <span class="n">removed_markers</span><span class="p">:</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">marker_id</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;removed duplicate&quot;</span>

    <span class="c1"># Writing the summary results</span>
    <span class="n">total_remaining</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="n">rep_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">duplicated_count</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rep_counter</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;Number of replicated markers&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;Number of replicated markers</span><span class="se">\t</span><span class="s2">0&quot;</span>
        <span class="n">total_nb_removed_rep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">rep_type</span><span class="p">,</span> <span class="n">rep_count</span> <span class="ow">in</span> <span class="n">rep_counter</span><span class="p">:</span>
            <span class="n">nb_removed_rep</span> <span class="o">=</span> <span class="p">(</span><span class="n">rep_count</span> <span class="o">*</span> <span class="n">rep_type</span><span class="p">)</span> <span class="o">-</span> <span class="n">rep_count</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;  - x{}</span><span class="se">\t</span><span class="s2">{:,d}</span><span class="se">\t</span><span class="s2">-{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">rep_type</span><span class="p">,</span>
                <span class="n">rep_count</span><span class="p">,</span>
                <span class="n">nb_removed_rep</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">total_nb_removed_rep</span> <span class="o">+=</span> <span class="n">nb_removed_rep</span>
        <span class="n">total_remaining</span> <span class="o">=</span> <span class="n">total_nb_removed_rep</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_markers</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Number of replicated markers kept</span><span class="se">\t</span><span class="s2">{nb:,d}</span><span class="se">\t</span><span class="s2">+{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">nb</span><span class="o">=</span><span class="n">total_remaining</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Poorly chosen replicated markers</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Final number of excluded markers</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">removed_markers</span><span class="p">)))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We create a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">duplicated_snps</span><span class="o">.</span><span class="n">pretty_name</span>
            <span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;A total of {:,d} duplicated marker{} {} found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">),</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicated_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;While merging duplicates, a total of {:,d} genotype{} {} &quot;</span>
                    <span class="s2">&quot;zeroed out. A total of {:,d} marker{} {} found to be not &quot;</span>
                    <span class="s2">&quot;good enough for duplicate completion.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_zeroed_out</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_zeroed_out</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">nb_zeroed_out</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">not_good_enough</span><span class="p">),</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_enough</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_enough</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;A total of {:,d} marker{} {} excluded while creating the &quot;</span>
                    <span class="s2">&quot;final dataset.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">removed_markers</span><span class="p">),</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_markers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_markers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">total_remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">textbf</span><span class="p">(</span>
                        <span class="s2">&quot;In total, {:,d} maker{} {} not merged for different &quot;</span>
                        <span class="s2">&quot;reasons (low completion rate, discordant allele, &quot;</span>
                        <span class="s2">&quot;discordant MAF, etc) and {} still present in the &quot;</span>
                        <span class="s2">&quot;dataset.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">total_remaining</span><span class="p">,</span>
                            <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">total_remaining</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">total_remaining</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;are&quot;</span> <span class="k">if</span> <span class="n">total_remaining</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;A total of&quot;</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot; and {} still present in the final dataset.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;are&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">total_remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;Out of these,&quot;</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">textbf</span><span class="p">(</span>
                        <span class="n">start</span> <span class="o">+</span> <span class="s2">&quot; {:,d} marker{} {} not good enough for &quot;</span>
                        <span class="s2">&quot;completion, but {} still selected as the best &quot;</span>
                        <span class="s2">&quot;duplicate{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">),</span>
                            <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_good_still</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                            <span class="n">end</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We know this step does produce a new data set (tfile), so we return it</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;dup_snps.final&quot;</span><span class="p">),</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="s2">&quot;tfile&quot;</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">duplicated_snps</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">duplicated_snps</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_noCall_hetero_snps"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_noCall_hetero_snps">[docs]</a><span class="k">def</span> <span class="nf">run_noCall_hetero_snps</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step 3 (clean no call and hetero).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``tfile``).</span>

<span class="sd">    This function calls the</span>
<span class="sd">    :py:mod:`pyGenClean.NoCallHetero.clean_noCall_hetero_snps` module. The</span>
<span class="sd">    required file type for this module is ``tfile``, hence the need to use the</span>
<span class="sd">    :py:func:`check_input_files` to check if the file input file type is the</span>
<span class="sd">    good one, or to create it if needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need a tfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;tfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;clean_noCall_hetero&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">noCall_hetero_snps</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">noCall_hetero_snps</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;noCall_hetero_snps: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We want to save in a file the markers and samples that were removed</span>
    <span class="c1"># There are two files to look at, which contains only one row, the name of</span>
    <span class="c1"># the markers:</span>
    <span class="c1">#     - prefix.allFailed</span>
    <span class="c1">#     - prefix.allHetero</span>
    <span class="n">nb_all_failed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nb_all_hetero</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">o_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;excluded_markers.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">o_filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="c1"># The first file</span>
        <span class="n">i_filename</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.allFailed&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">i_filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">i_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                    <span class="n">nb_all_failed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">all failed&quot;</span>

        <span class="c1"># The second file</span>
        <span class="n">i_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.allHetero&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">i_filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">i_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                    <span class="n">nb_all_hetero</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">all hetero&quot;</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">noCall_hetero_snps</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;After scrutiny, {:,d} marker{} {} excluded from the &quot;</span>
                <span class="s2">&quot;dataset because of a call rate of 0. Also, {:,d} marker{} &quot;</span>
                <span class="s2">&quot;{} excluded from the dataset because all samples were &quot;</span>
                <span class="s2">&quot;heterozygous (excluding the mitochondrial &quot;</span>
                <span class="s2">&quot;chromosome)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_all_failed</span><span class="p">,</span>
                                     <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_all_failed</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">nb_all_failed</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                                     <span class="n">nb_all_hetero</span><span class="p">,</span>
                                     <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_all_hetero</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">nb_all_hetero</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of completely failed markers</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{nb:,d}</span><span class="se">\t</span><span class="s2">-{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb</span><span class="o">=</span><span class="n">nb_all_failed</span><span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of all heterozygous markers</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{nb:,d}</span><span class="se">\t</span><span class="s2">-{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb</span><span class="o">=</span><span class="n">nb_all_hetero</span><span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step does produce a new data set (tfile), so we return it</span>
    <span class="c1"># along with the report name</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;clean_noCall_hetero&quot;</span><span class="p">),</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="s2">&quot;tfile&quot;</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">noCall_hetero_snps</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">noCall_hetero_snps</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_sample_missingness"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_sample_missingness">[docs]</a><span class="k">def</span> <span class="nf">run_sample_missingness</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step4 (clean mind).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the</span>
<span class="sd">    :py:mod:`pyGenClean.SampleMissingness.sample_missingness` module. The</span>
<span class="sd">    required file type for this module is either a ``bfile`` or a ``tfile``,</span>
<span class="sd">    hence the need to use the :py:func:`check_input_files` to check if the file</span>
<span class="sd">    input file type is the good one, or to create it if needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We are looking at what we have</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;tfile&quot;</span>
    <span class="k">if</span> <span class="n">in_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
        <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;clean_mind&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--ifile&quot;</span><span class="p">,</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">required_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--is-bfile&quot;</span><span class="p">)</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sample_missingness</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sample_missingness</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;sample_missingness: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We want to modify the description, so that it contains the option used</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">sample_missingness</span><span class="o">.</span><span class="n">desc</span>
    <span class="n">mind_value</span> <span class="o">=</span> <span class="n">sample_missingness</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_default</span><span class="p">(</span><span class="s2">&quot;mind&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;--mind&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="c1"># Since we already run the script, we know that the mind option is a</span>
        <span class="c1"># valid float</span>
        <span class="n">mind_value</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--mind&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">r&quot; (${}={}$).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_template</span><span class="o">.</span><span class="n">texttt</span><span class="p">(</span><span class="s2">&quot;mind&quot;</span><span class="p">),</span>
                                                 <span class="n">mind_value</span><span class="p">)</span>
    <span class="n">long_description</span> <span class="o">=</span> <span class="n">sample_missingness</span><span class="o">.</span><span class="n">long_desc</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">success_rate</span><span class="o">=</span><span class="s2">&quot;{:.1f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">mind_value</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># We want to save in a file the samples that were removed</span>
    <span class="c1"># There is one file to look at, which contains only one row, the name of</span>
    <span class="c1"># the samples:</span>
    <span class="c1">#     - prefix.irem (file will exists only if samples were removed)</span>
    <span class="n">nb_samples</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">o_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;excluded_samples.txt&quot;</span><span class="p">)</span>
    <span class="n">i_filename</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.irem&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">i_filename</span><span class="p">):</span>
        <span class="c1"># True, so sample were removed</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">i_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">o_filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                <span class="n">nb_samples</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">mind {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mind_value</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">sample_missingness</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Using a {} threshold of {} ({} keeping only samples with &quot;</span>
                    <span class="s2">r&quot;a missing rate $\leq {}$), {:,d} sample{} {} excluded &quot;</span>
                    <span class="s2">&quot;from the dataset.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">latex_template</span><span class="o">.</span><span class="n">texttt</span><span class="p">(</span><span class="s2">&quot;mind&quot;</span><span class="p">),</span>
                        <span class="n">mind_value</span><span class="p">,</span>
                        <span class="n">latex_template</span><span class="o">.</span><span class="n">textit</span><span class="p">(</span><span class="s2">&quot;i.e.&quot;</span><span class="p">),</span>
                        <span class="n">mind_value</span><span class="p">,</span>
                        <span class="n">nb_samples</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_samples</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">nb_samples</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                    <span class="p">))</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of samples with missing rate less or equal &quot;</span>
                         <span class="s2">&quot;to {t}</span><span class="se">\t</span><span class="s2">{nb:,d}</span><span class="se">\t\t</span><span class="s2">-{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">t</span><span class="o">=</span><span class="n">mind_value</span><span class="p">,</span>
                            <span class="n">nb</span><span class="o">=</span><span class="n">nb_samples</span><span class="p">,</span>
                         <span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step does produce a new data set (bfile), so we return it</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;clean_mind&quot;</span><span class="p">),</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="s2">&quot;bfile&quot;</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">long_description</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_snp_missingness"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_snp_missingness">[docs]</a><span class="k">def</span> <span class="nf">run_snp_missingness</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run step5 (clean geno).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the</span>
<span class="sd">    :py:mod:`pyGenClean.MarkerMissingness.snp_missingness` module. The required</span>
<span class="sd">    file type for this module is ``bfile``, hence the need to use the</span>
<span class="sd">    :py:func:`check_input_files` to check if the file input file type is the</span>
<span class="sd">    good one, or to create it if needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need a bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;clean_geno&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">snp_missingness</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">snp_missingness</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;snp_missingness: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We want to modify the description, so that it contains the option used</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">snp_missingness</span><span class="o">.</span><span class="n">desc</span>
    <span class="n">geno_value</span> <span class="o">=</span> <span class="n">snp_missingness</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_default</span><span class="p">(</span><span class="s2">&quot;geno&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;--geno&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="c1"># Since we already run the script, we know that the mind option is a</span>
        <span class="c1"># valid float</span>
        <span class="n">geno_value</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--geno&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">r&quot; (${}={}$).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_template</span><span class="o">.</span><span class="n">texttt</span><span class="p">(</span><span class="s2">&quot;geno&quot;</span><span class="p">),</span>
                                                 <span class="n">geno_value</span><span class="p">)</span>
    <span class="n">long_description</span> <span class="o">=</span> <span class="n">sample_missingness</span><span class="o">.</span><span class="n">long_desc</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">success_rate</span><span class="o">=</span><span class="s2">&quot;{:.1f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">geno_value</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># We want to save in a file the samples that were removed</span>
    <span class="c1"># There is one file to look at, which contains only one row, the name of</span>
    <span class="c1"># the samples:</span>
    <span class="c1">#     - prefix.removed_snps</span>
    <span class="n">nb_markers</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">o_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;excluded_markers.txt&quot;</span><span class="p">)</span>
    <span class="c1"># Checking if the file exists</span>
    <span class="n">i_filename</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.removed_snps&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">i_filename</span><span class="p">):</span>
        <span class="c1"># True, so sample were removed</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">i_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">,</span> \
                <span class="nb">open</span><span class="p">(</span><span class="n">o_filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                <span class="n">nb_markers</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">geno {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">geno_value</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">snp_missingness</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Using a {} threshold of {} ({} keeping only markers with &quot;</span>
                    <span class="s2">r&quot;a missing rate $\leq {}$), {:,d} marker{} {} excluded &quot;</span>
                    <span class="s2">&quot;from the dataset.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">latex_template</span><span class="o">.</span><span class="n">texttt</span><span class="p">(</span><span class="s2">&quot;geno&quot;</span><span class="p">),</span>
                        <span class="n">geno_value</span><span class="p">,</span>
                        <span class="n">latex_template</span><span class="o">.</span><span class="n">textit</span><span class="p">(</span><span class="s2">&quot;i.e.&quot;</span><span class="p">),</span>
                        <span class="n">geno_value</span><span class="p">,</span> <span class="n">nb_markers</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_markers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">nb_markers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                    <span class="p">))</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of markers with missing rate less or equal &quot;</span>
                         <span class="s2">&quot;to {t}</span><span class="se">\t</span><span class="s2">{nb:,d}</span><span class="se">\t</span><span class="s2">-{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">t</span><span class="o">=</span><span class="n">geno_value</span><span class="p">,</span>
                            <span class="n">nb</span><span class="o">=</span><span class="n">nb_markers</span><span class="p">,</span>
                         <span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step does produce a new data set (bfile), so we return it</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;clean_geno&quot;</span><span class="p">),</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="s2">&quot;bfile&quot;</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">long_description</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_contamination"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_contamination">[docs]</a><span class="k">def</span> <span class="nf">run_contamination</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs the contamination check for samples.</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need a bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;contamination&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">contamination</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">contamination</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;contamination: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Counting the number of markers used for contamination</span>
    <span class="n">nb_autosomal</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.to_extract&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">nb_autosomal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

    <span class="c1"># Reading the &quot;contamination&quot; file</span>
    <span class="n">nb_tested_samples</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">contaminated_table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nb_contaminated_samples</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.bafRegress&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">i_file</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">contaminated_table</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;estimate$^1$&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;stderr$^1$&quot;</span><span class="p">,</span> <span class="s2">&quot;tval&quot;</span><span class="p">,</span> <span class="s2">&quot;pval&quot;</span><span class="p">,</span>
                                           <span class="s2">&quot;callrate&quot;</span><span class="p">,</span> <span class="s2">&quot;Nhom$^2$&quot;</span><span class="p">))</span>
                <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">)}</span>

                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;tval&quot;</span><span class="p">,</span> <span class="s2">&quot;pval&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;callrate&quot;</span><span class="p">,</span> <span class="s2">&quot;Nhom&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="s2">&quot;{}: missing column {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.bafRegress&quot;</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span>
                        <span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># One more sample</span>
            <span class="n">nb_tested_samples</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Reading the data</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">estimate</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="c1"># This might be a contaminated samples</span>
                <span class="n">contaminated_table</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]]),</span>
                    <span class="s2">&quot;{:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]])),</span>
                    <span class="s2">&quot;{:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;stderr&quot;</span><span class="p">]])),</span>
                    <span class="s2">&quot;{:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;tval&quot;</span><span class="p">]])),</span>
                    <span class="n">latex_template</span><span class="o">.</span><span class="n">format_numbers</span><span class="p">(</span><span class="s2">&quot;{:.3e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;pval&quot;</span><span class="p">]]),</span>
                    <span class="p">)),</span>
                    <span class="s2">&quot;{:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;callrate&quot;</span><span class="p">]])),</span>
                    <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;Nhom&quot;</span><span class="p">]])),</span>
                <span class="p">))</span>
                <span class="n">nb_contaminated_samples</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">contamination</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A total of {:,d} sample{} {} analyzed for contamination &quot;</span>
                    <span class="s2">r&quot;using \textit{bafRegress}\cite{bafRegress}. The &quot;</span>
                    <span class="s2">&quot;analysis was performed using {:,d} autosomal marker{}. &quot;</span>
                    <span class="s2">&quot;Using a threshold of 0.01, {:,d} sample{} {} estimated &quot;</span>
                    <span class="s2">&quot;to be contaminated.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_tested_samples</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_tested_samples</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">nb_tested_samples</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                        <span class="n">nb_autosomal</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_autosomal</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_contaminated_samples</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_contaminated_samples</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="n">nb_contaminated_samples</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                        <span class="n">bafRegress</span><span class="o">=</span><span class="s2">&quot;{bafRegress}&quot;</span><span class="p">,</span>
                    <span class="p">))</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nb_contaminated_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Table~\ref{&quot;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;} list all the samples that &quot;</span>
                    <span class="s2">r&quot;were estimated to be contaminated (\textit{i.e.} with &quot;</span>
                    <span class="s2">r&quot;an estimate $&gt;0.01$).&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="c1"># Getting the template</span>
                <span class="n">longtable_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;longtable_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Rendering</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">longtable_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">table_caption</span><span class="o">=</span><span class="s2">r&quot;List of all possible contaminated samples &quot;</span>
                                  <span class="s2">r&quot;(\textit{i.e.} with an estimate computed &quot;</span>
                                  <span class="s2">r&quot;by \textit{bafRegress} $&gt;0.01$).&quot;</span><span class="p">,</span>
                    <span class="n">table_label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">nb_col</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contaminated_table</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">col_alignments</span><span class="o">=</span><span class="s2">&quot;lrrrrrr&quot;</span><span class="p">,</span>
                    <span class="n">text_size</span><span class="o">=</span><span class="s2">&quot;scriptsize&quot;</span><span class="p">,</span>
                    <span class="n">header_data</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">contaminated_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">contaminated_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                    <span class="n">tabular_data</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span>
                        <span class="n">contaminated_table</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">),</span>
                    <span class="n">footnotes</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;$^1$Contamination estimate (with standard error)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;$^2$Number of homozygous genotypes used in the model&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of possibly contaminated &quot;</span>
                         <span class="s2">&quot;samples</span><span class="se">\t</span><span class="s2">{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_contaminated_samples</span><span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step doesn&#39;t produce an new data set, so we return the old</span>
    <span class="c1"># prefix and the old in_type</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">contamination</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">contamination</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_sex_check"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_sex_check">[docs]</a><span class="k">def</span> <span class="nf">run_sex_check</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step6 (sexcheck).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the :py:mod:`pyGenClean.SexCheck.sex_check` module. The</span>
<span class="sd">    required file type for this module is ``bfile``, hence the need to use the</span>
<span class="sd">    :py:func:`check_input_files` to check if the file input file type is the</span>
<span class="sd">    good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The :py:mod:`pyGenClean.SexCheck.sex_check` module doesn&#39;t return</span>
<span class="sd">        usable output files. Hence, this function returns the input file prefix</span>
<span class="sd">        and its type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need a bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;sexcheck&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sex_check</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sex_check</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;sex_check {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Reading the hetero file on X</span>
    <span class="n">hetero</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chr23_recodeA.raw.hetero&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chr23_recodeA.raw.hetero&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span>
                <span class="nb">enumerate</span><span class="p">(</span><span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()))</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">required_col</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;PED&quot;</span><span class="p">,</span> <span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;HETERO&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">required_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no column named {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chr23_recodeA.raw.hetero&quot;</span><span class="p">,</span>
                        <span class="n">required_col</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Reading the data</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">famid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;PED&quot;</span><span class="p">]]</span>
                <span class="n">indid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]]</span>

                <span class="c1"># Formatting the hetero value</span>
                <span class="n">het</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">het</span> <span class="o">=</span> <span class="s2">&quot;{:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HETERO&quot;</span><span class="p">]]))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">het</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>

                <span class="n">hetero</span><span class="p">[(</span><span class="n">famid</span><span class="p">,</span> <span class="n">indid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">het</span>

    <span class="c1"># Reading the number of no call on Y</span>
    <span class="n">nb_no_call</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chr24_recodeA.raw.noCall&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chr24_recodeA.raw.noCall&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span>
                <span class="nb">enumerate</span><span class="p">(</span><span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()))</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">required_col</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;PED&quot;</span><span class="p">,</span> <span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;nbGeno&quot;</span><span class="p">,</span> <span class="s2">&quot;nbNoCall&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">required_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no column named {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.chr24_recodeA.raw.noCall&quot;</span><span class="p">,</span>
                        <span class="n">required_col</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Reading the data</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">famid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;PED&quot;</span><span class="p">]]</span>
                <span class="n">indid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]]</span>

                <span class="c1"># Getting the statistics</span>
                <span class="n">nb_geno</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;nbGeno&quot;</span><span class="p">]]</span>
                <span class="n">nb_nocall</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;nbNoCall&quot;</span><span class="p">]]</span>

                <span class="n">percent</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">percent</span> <span class="o">=</span> <span class="s2">&quot;{:.4f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">nb_nocall</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nb_geno</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">percent</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
                <span class="n">nb_no_call</span><span class="p">[(</span><span class="n">famid</span><span class="p">,</span> <span class="n">indid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">percent</span>

    <span class="c1"># Reading the problem file to gather statistics. Note that dataset without</span>
    <span class="c1"># problem will only have the header line (and no data)</span>
    <span class="n">nb_problems</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nb_no_genetic</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nb_discordant</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.list_problem_sex&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="c1"># Reading the header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">i_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">header</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">required_col</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;FID&quot;</span><span class="p">,</span> <span class="s2">&quot;IID&quot;</span><span class="p">,</span> <span class="s2">&quot;SNPSEX&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">required_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no column named {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.list_problem_sex&quot;</span><span class="p">,</span>
                    <span class="n">required_col</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Adding the missing column name</span>
        <span class="n">table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;HET&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">r&quot;\%NOCALL&quot;</span><span class="p">)</span>

        <span class="c1"># Reading the rest of the data</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">nb_problems</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Creating the row</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Counting</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;SNPSEX&quot;</span><span class="p">]]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">nb_no_genetic</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nb_discordant</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="n">name</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;FID&quot;</span><span class="p">,</span> <span class="s2">&quot;IID&quot;</span><span class="p">,</span> <span class="s2">&quot;PEDSEX&quot;</span><span class="p">,</span> <span class="s2">&quot;SNPSEX&quot;</span><span class="p">,</span> <span class="s2">&quot;STATUS&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="n">table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">hetero</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FID&quot;</span><span class="p">]],</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;IID&quot;</span><span class="p">]]),</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">nb_no_call</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FID&quot;</span><span class="p">]],</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;IID&quot;</span><span class="p">]]),</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Getting the value for the maleF option</span>
    <span class="n">male_f</span> <span class="o">=</span> <span class="n">sex_check</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_default</span><span class="p">(</span><span class="s2">&quot;maleF&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;--maleF&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">male_f</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--maleF&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Getting the value for the femaleF option</span>
    <span class="n">female_f</span> <span class="o">=</span> <span class="n">sex_check</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_default</span><span class="p">(</span><span class="s2">&quot;femaleF&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;--femaleF&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">female_f</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--femaleF&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="n">graphics_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span><span class="n">sex_check</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Using $F$ thresholds of {male_f} and {female_f} for males &quot;</span>
                <span class="s2">&quot;and females respectively, {nb_problems:,d} sample{plural} &quot;</span>
                <span class="s2">&quot;had gender problem according to Plink.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">male_f</span><span class="o">=</span><span class="n">male_f</span><span class="p">,</span>
                    <span class="n">female_f</span><span class="o">=</span><span class="n">female_f</span><span class="p">,</span>
                    <span class="n">nb_problems</span><span class="o">=</span><span class="n">nb_problems</span><span class="p">,</span>
                    <span class="n">plural</span><span class="o">=</span><span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_problems</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># The float template</span>
            <span class="n">float_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                <span class="s2">&quot;float_template.tex&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">nb_problems</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># The label and text for the table</span>
                <span class="n">table_label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_&quot;</span><span class="p">,</span>
                    <span class="n">script_prefix</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_problems&quot;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Table~\ref{&quot;</span> <span class="o">+</span> <span class="n">table_label</span> <span class="o">+</span> <span class="s2">&quot;} summarizes the gender &quot;</span>
                    <span class="s2">&quot;problems encountered during the analysis.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="c1"># Getting the template</span>
                <span class="n">longtable_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;longtable_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Rendering</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">longtable_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">table_caption</span><span class="o">=</span><span class="s2">&quot;Summarization of the gender problems &quot;</span>
                                  <span class="s2">&quot;encountered during Plink&#39;s analysis. &quot;</span>
                                  <span class="s2">&quot;HET is the heterozygosity rate on the X &quot;</span>
                                  <span class="s2">r&quot;chromosome. \%NOCALL is the percentage of &quot;</span>
                                  <span class="s2">&quot;no calls on the Y chromosome.&quot;</span><span class="p">,</span>
                    <span class="n">table_label</span><span class="o">=</span><span class="n">table_label</span><span class="p">,</span>
                    <span class="n">nb_col</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">col_alignments</span><span class="o">=</span><span class="s2">&quot;llrrlrrrr&quot;</span><span class="p">,</span>
                    <span class="n">text_size</span><span class="o">=</span><span class="s2">&quot;scriptsize&quot;</span><span class="p">,</span>
                    <span class="n">header_data</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                    <span class="n">tabular_data</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">)</span>

            <span class="c1"># Getting the templates</span>
            <span class="n">graphic_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                <span class="s2">&quot;graphics_template.tex&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># If there is a figure, we add it here</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">):</span>
                <span class="c1"># Adding the figure</span>
                <span class="n">figure_label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Figure~\ref{&quot;</span> <span class="o">+</span> <span class="n">figure_label</span> <span class="o">+</span> <span class="s2">r&quot;} shows the $\bar{y}$ &quot;</span>
                    <span class="s2">r&quot;intensities versus the $\bar{x}$ intensities for each &quot;</span>
                    <span class="s2">&quot;samples. Problematic samples are shown using triangles.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="c1"># Getting the paths</span>
                <span class="n">graphics_path</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)</span>
                <span class="n">graphics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span>

                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">float_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">float_type</span><span class="o">=</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span>
                    <span class="n">float_placement</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">,</span>
                    <span class="n">float_caption</span><span class="o">=</span><span class="s2">&quot;Gender check using Plink. Mean $x$ and $y$ &quot;</span>
                                  <span class="s2">&quot;intensities are shown for each sample. &quot;</span>
                                  <span class="s2">&quot;Males are shown in blue, and females in &quot;</span>
                                  <span class="s2">&quot;red. Triangles show problematic samples &quot;</span>
                                  <span class="s2">&quot;(green for males, mauve for females). &quot;</span>
                                  <span class="s2">&quot;Unknown gender are shown in gray.&quot;</span><span class="p">,</span>
                    <span class="n">float_label</span><span class="o">=</span><span class="n">figure_label</span><span class="p">,</span>
                    <span class="n">float_content</span><span class="o">=</span><span class="n">graphic_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                        <span class="n">width</span><span class="o">=</span><span class="s2">r&quot;0.8\textwidth&quot;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_fig_name</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Adding the path where the graphic is</span>
                <span class="n">graphics_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">)</span>

            <span class="c1"># If there is a &#39;sexcheck.LRR_BAF&#39; directory, then there are LRR</span>
            <span class="c1"># and BAF plots.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.LRR_BAF&quot;</span><span class="p">):</span>
                <span class="n">figures</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.LRR_BAF&quot;</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Getting the sample IDs</span>
                    <span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                            <span class="s2">&quot;^baf_lrr_(\S+)_lrr_baf.png$&quot;</span><span class="p">,</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">figure</span><span class="p">),</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">figures</span>
                    <span class="p">]</span>
                    <span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;unknown sample&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sample</span> <span class="k">else</span> <span class="n">sample</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_ids</span>
                    <span class="p">]</span>

                    <span class="c1"># Sorting according to sample IDs</span>
                    <span class="n">sorted_indexes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)),</span>
                                            <span class="n">key</span><span class="o">=</span><span class="n">figures</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">)</span>
                    <span class="n">figures</span> <span class="o">=</span> <span class="p">[</span><span class="n">figures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_indexes</span><span class="p">]</span>
                    <span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_indexes</span><span class="p">]</span>

                    <span class="c1"># Getting the labels</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                            <span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;_&quot;</span><span class="p">,</span>
                            <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;_baf_lrr_&quot;</span> <span class="o">+</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">sample</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_ids</span>
                    <span class="p">]</span>

                    <span class="n">fig_1</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fig_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">fig_2</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Figure&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">r&quot;~\ref{&quot;</span> <span class="o">+</span> <span class="n">fig_1</span> <span class="o">+</span> <span class="s2">&quot;} &quot;</span> <span class="o">+</span>
                        <span class="p">(</span><span class="s2">r&quot;to \ref{&quot;</span> <span class="o">+</span> <span class="n">fig_2</span> <span class="o">+</span> <span class="s2">&quot;} &quot;</span> <span class="k">if</span> <span class="n">fig_2</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s2">&quot;show&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;s &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;the &quot;</span>
                        <span class="s2">&quot;log R ratio and the B allele frequency versus the &quot;</span>
                        <span class="s2">&quot;position on chromosome X and Y for the problematic &quot;</span>
                        <span class="s2">&quot;sample{}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">figures</span><span class="p">,</span> <span class="n">sample_ids</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">figure</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
                        <span class="n">sample_id</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">sample_id</span><span class="p">)</span>

                        <span class="c1"># Getting the paths</span>
                        <span class="n">graphics_path</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
                        <span class="n">graphics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">,</span>
                                                        <span class="n">base_dir</span><span class="p">)</span>

                        <span class="n">caption</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;Plots showing the log R ratio and the B allele &quot;</span>
                            <span class="s2">&quot;frequency for chromosome X and Y (on the left &quot;</span>
                            <span class="s2">&quot;and right, respectively) for sample &quot;</span>
                            <span class="s2">&quot;{}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_id</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">float_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                            <span class="n">float_type</span><span class="o">=</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span>
                            <span class="n">float_placement</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">,</span>
                            <span class="n">float_caption</span><span class="o">=</span><span class="n">caption</span><span class="p">,</span>
                            <span class="n">float_label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="n">float_content</span><span class="o">=</span><span class="n">graphic_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                                <span class="n">width</span><span class="o">=</span><span class="s2">r&quot;\textwidth&quot;</span><span class="p">,</span>
                                <span class="n">path</span><span class="o">=</span><span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_fig_name</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                <span class="c1"># Adding the path where the graphic is</span>
                <span class="n">graphics_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;Number of samples with gender problem&quot;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;  - no genetic gender</span><span class="se">\t</span><span class="s2">{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_no_genetic</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;  - discordant gender</span><span class="se">\t</span><span class="s2">{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_discordant</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step does not produce a new data set, so we return the</span>
    <span class="c1"># original one</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">sex_check</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">sex_check</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="n">graphics_paths</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_plate_bias"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_plate_bias">[docs]</a><span class="k">def</span> <span class="nf">run_plate_bias</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step7 (plate bias).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the :py:mod:`pyGenClean.PlateBias.plate_bias` module.</span>
<span class="sd">    The required file type for this module is ``bfile``, hence the need to use</span>
<span class="sd">    the :py:func:`check_input_files` to check if the file input file type is</span>
<span class="sd">    the good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The :py:mod:`pyGenClean.PlateBias.plate_bias` module doesn&#39;t return</span>
<span class="sd">        usable output files. Hence, this function returns the input file prefix</span>
<span class="sd">        and its type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;plate_bias&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plate_bias</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">plate_bias</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;plate_bias: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># The name of the summary file</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.significant_SNPs.summary&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="s2">&quot;{}: no such file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="c1"># Getting the number of each plate</span>
    <span class="n">plate_counter</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;plate&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: missing column plate&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Counting the number of markers for each plate</span>
        <span class="n">plate_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
            <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;plate&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span>
        <span class="p">)</span>

    <span class="c1"># Creating the table</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;plate name&quot;</span><span class="p">,</span> <span class="s2">&quot;number of markers&quot;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">plate_name</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">plate_counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">plate_name</span><span class="p">),</span>
            <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">),</span>
        <span class="p">])</span>

    <span class="c1"># The number of unique markers</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.significant_SNPs.txt&quot;</span>
    <span class="n">nb_markers</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">nb_markers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">({</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">})</span>

    <span class="c1"># Getting the p value threshold</span>
    <span class="n">p_threshold</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">plate_bias</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_default</span><span class="p">(</span><span class="s2">&quot;pfilter&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s2">&quot;--pfilter&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">p_threshold</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--pfilter&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span><span class="n">plate_bias</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;After performing the plate bias analysis using Plink, a &quot;</span>
                <span class="s2">&quot;total of {:,d} unique marker{} had a significant result &quot;</span>
                <span class="s2">&quot;({} a value less than {}).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nb_markers</span><span class="p">,</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_markers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">r&quot;\textit{i.e.}&quot;</span><span class="p">,</span>
                    <span class="n">latex_template</span><span class="o">.</span><span class="n">format_numbers</span><span class="p">(</span><span class="n">p_threshold</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nb_markers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">table_label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_&quot;</span><span class="p">,</span>
                    <span class="n">script_prefix</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_plate_bias&quot;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Table~\ref{&quot;</span> <span class="o">+</span> <span class="n">table_label</span> <span class="o">+</span> <span class="s2">&quot;} summarizes the plate &quot;</span>
                    <span class="s2">&quot;bias results.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="c1"># Getting the template</span>
                <span class="n">longtable_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;longtable_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># The table caption</span>
                <span class="n">table_caption</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Summary of the plate bias analysis performed by Plink. &quot;</span>
                    <span class="s2">&quot;For each plate, the number of significant marker{} is &quot;</span>
                    <span class="s2">&quot;shown (threshold of {}). The plates are sorted according &quot;</span>
                    <span class="s2">&quot;to the total number of significant results.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_markers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">latex_template</span><span class="o">.</span><span class="n">format_numbers</span><span class="p">(</span><span class="n">p_threshold</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">longtable_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">table_caption</span><span class="o">=</span><span class="n">table_caption</span><span class="p">,</span>
                    <span class="n">table_label</span><span class="o">=</span><span class="n">table_label</span><span class="p">,</span>
                    <span class="n">nb_col</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">col_alignments</span><span class="o">=</span><span class="s2">&quot;lr&quot;</span><span class="p">,</span>
                    <span class="n">text_size</span><span class="o">=</span><span class="s2">&quot;normalsize&quot;</span><span class="p">,</span>
                    <span class="n">header_data</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                    <span class="n">tabular_data</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of markers with plate bias (p&lt;{})</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_threshold</span><span class="p">,</span> <span class="n">nb_markers</span><span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step doesn&#39;t produce an new data set, so we return the old</span>
    <span class="c1"># prefix and the old in_type</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">plate_bias</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">plate_bias</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_remove_heterozygous_haploid"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_remove_heterozygous_haploid">[docs]</a><span class="k">def</span> <span class="nf">run_remove_heterozygous_haploid</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span>
                                    <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step8 (remove heterozygous haploid).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the</span>
<span class="sd">    :py:mod:`pyGenClean.HeteroHap.remove_heterozygous_haploid` module. The</span>
<span class="sd">    required file type for this module is ``bfile``, hence the need to use the</span>
<span class="sd">    :py:func:`check_input_files` to check if the file input file type is the</span>
<span class="sd">    good one, or to create it if needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;without_hh_genotypes&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">remove_heterozygous_haploid</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">remove_heterozygous_haploid</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;remove_heterozygous_haploid: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We get the number of genotypes that were set to missing</span>
    <span class="n">nb_hh_missing</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">nb_hh_missing</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="s2">r&quot;(\d+) heterozygous haploid genotypes; set to missing&quot;</span><span class="p">,</span>
            <span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_hh_missing</span><span class="p">:</span>
        <span class="n">nb_hh_missing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_hh_missing</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">remove_heterozygous_haploid</span><span class="o">.</span><span class="n">pretty_name</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;After Plink&#39;s heterozygous haploid analysis, a total of &quot;</span>
                <span class="s2">&quot;{:,d} genotype{} were set to missing.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nb_hh_missing</span><span class="p">,</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_hh_missing</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of heterozygous haploid genotypes set to &quot;</span>
                         <span class="s2">&quot;missing</span><span class="se">\t</span><span class="s2">{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_hh_missing</span><span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step produces an new data set (bfile), so we return it</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;without_hh_genotypes&quot;</span><span class="p">),</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="s2">&quot;bfile&quot;</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">remove_heterozygous_haploid</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">remove_heterozygous_haploid</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_find_related_samples"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_find_related_samples">[docs]</a><span class="k">def</span> <span class="nf">run_find_related_samples</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span>
                             <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step9 (find related samples).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the</span>
<span class="sd">    :py:mod:`pyGenClean.RelatedSamples.find_related_samples` module. The</span>
<span class="sd">    required file type for this module is ``bfile``, hence the need to use the</span>
<span class="sd">    :py:func:`check_input_files` to check if the file input file type is the</span>
<span class="sd">    good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The :py:mod:`pyGenClean.RelatedSamples.find_related_samples` module</span>
<span class="sd">        doesn&#39;t return usable output files. Hence, this function returns the</span>
<span class="sd">        input file prefix and its type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;ibs&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># The IBS2 ratio</span>
    <span class="n">ibs2_ratio</span> <span class="o">=</span> <span class="n">find_related_samples</span><span class="o">.</span><span class="n">_ibs2_ratio_default</span>
    <span class="k">if</span> <span class="s2">&quot;--ibs2-ratio&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">ibs2_ratio</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--ibs2-ratio&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># The indep pairwiase</span>
    <span class="n">r2_value</span> <span class="o">=</span> <span class="n">find_related_samples</span><span class="o">.</span><span class="n">_indep_pairwise_r2_default</span>
    <span class="k">if</span> <span class="s2">&quot;--indep-pairwise&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">r2_value</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--indep-pairwise&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">find_related_samples</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">find_related_samples</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;find_related_samples: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Reading the file containing all samples that are related</span>
    <span class="c1">#   - ibs.related_individuals</span>
    <span class="n">related_samples</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.related_individuals&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()))</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">required_col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;FID1&quot;</span><span class="p">,</span> <span class="s2">&quot;IID1&quot;</span><span class="p">,</span> <span class="s2">&quot;FID2&quot;</span><span class="p">,</span> <span class="s2">&quot;IID2&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">required_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: missing column {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.related_individuals&quot;</span><span class="p">,</span>
                    <span class="n">required_col</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Reading the rest of the data</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">related_samples</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FID1&quot;</span><span class="p">]],</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;IID1&quot;</span><span class="p">]]))</span>
            <span class="n">related_samples</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;FID2&quot;</span><span class="p">]],</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;IID2&quot;</span><span class="p">]]))</span>

    <span class="c1"># Reading file containing samples that should be discarded</span>
    <span class="c1">#   - ibs.discarded_related_individuals</span>
    <span class="n">discarded_samples</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.discarded_related_individuals&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">discarded_samples</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">i_file</span>
        <span class="p">}</span>

    <span class="c1"># Counting the number of markers used for computing IBS values</span>
    <span class="n">nb_markers_ibs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.pruned_data.bim&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">nb_markers_ibs</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Reading the merged related individuals file</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.merged_related_individuals&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">])</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="n">graphics_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">find_related_samples</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;According to Plink relatedness analysis (using {:,d} &quot;</span>
                <span class="s2">&quot;marker{}), {:,d} unique sample{} {} related to at least one &quot;</span>
                <span class="s2">&quot;other sample. A total of {:,d} sample{} {} randomly selected &quot;</span>
                <span class="s2">&quot;for downstream exclusion from the dataset.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nb_markers_ibs</span><span class="p">,</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_markers_ibs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">related_samples</span><span class="p">),</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">discarded_samples</span><span class="p">),</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">discarded_samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;were&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">discarded_samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;was&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># Adding the first figure (if present)</span>
            <span class="n">fig_1</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.related_individuals_z1.png&quot;</span>
            <span class="n">fig_1_label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_z1&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fig_1</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Figure~\ref{&quot;</span> <span class="o">+</span> <span class="n">fig_1_label</span> <span class="o">+</span> <span class="s2">&quot;} shows $Z_1$ versus &quot;</span>
                    <span class="s2">r&quot;$IBS2_{ratio}^\ast$ for all related samples found by &quot;</span>
                    <span class="s2">r&quot;Plink.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># Adding the second figure (if present)</span>
            <span class="n">fig_2</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.related_individuals_z2.png&quot;</span>
            <span class="n">fig_2_label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_z2&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fig_2</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Figure~\ref{&quot;</span> <span class="o">+</span> <span class="n">fig_2_label</span> <span class="o">+</span> <span class="s2">&quot;} shows $Z_2$ versus &quot;</span>
                    <span class="s2">r&quot;$IBS2_{ratio}^\ast$ for all related samples found by &quot;</span>
                    <span class="s2">r&quot;Plink.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># There is data, so we add</span>
                <span class="n">table_label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_related&quot;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Table~\ref{&quot;</span> <span class="o">+</span> <span class="n">table_label</span> <span class="o">+</span> <span class="s2">&quot;} lists the related &quot;</span>
                    <span class="s2">&quot;sample pairs with estimated relationship.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># Getting the required template</span>
            <span class="n">float_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                <span class="s2">&quot;float_template.tex&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">graphic_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                <span class="s2">&quot;graphics_template.tex&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">figures</span> <span class="o">=</span> <span class="p">(</span><span class="n">fig_1</span><span class="p">,</span> <span class="n">fig_2</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">fig_1_label</span><span class="p">,</span> <span class="n">fig_2_label</span><span class="p">)</span>
            <span class="n">graph_types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;$Z_1$&quot;</span><span class="p">,</span> <span class="s2">&quot;$Z_2$&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fig</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">graph_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">figures</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">graph_types</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
                    <span class="c1"># Getting the paths</span>
                    <span class="n">graphics_path</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                    <span class="n">graphics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span>

                    <span class="c1"># Printing</span>
                    <span class="n">caption</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">graph_type</span> <span class="o">+</span> <span class="s2">r&quot; versus $IBS2_{ratio}^\ast$ for all &quot;</span>
                        <span class="s2">&quot;related samples found by Plink in the IBS analysis.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">float_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                        <span class="n">float_type</span><span class="o">=</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span>
                        <span class="n">float_placement</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">,</span>
                        <span class="n">float_caption</span><span class="o">=</span><span class="n">caption</span><span class="p">,</span>
                        <span class="n">float_label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                        <span class="n">float_content</span><span class="o">=</span><span class="n">graphic_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                            <span class="n">width</span><span class="o">=</span><span class="s2">r&quot;0.8\textwidth&quot;</span><span class="p">,</span>
                            <span class="n">path</span><span class="o">=</span><span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_fig_name</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="c1"># Adding the path where the graphic is</span>
                    <span class="n">graphics_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">)</span>

            <span class="c1"># Adding the table</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Getting the template</span>
                <span class="n">longtable_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;longtable_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># The table caption</span>
                <span class="n">table_caption</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;List of all related samples with estimated relationship. &quot;</span>
                    <span class="s2">&quot;Sample pairs are grouped according to their estimated &quot;</span>
                    <span class="s2">&quot;family (the index column).&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">longtable_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">table_caption</span><span class="o">=</span><span class="n">table_caption</span><span class="p">,</span>
                    <span class="n">table_label</span><span class="o">=</span><span class="n">table_label</span><span class="p">,</span>
                    <span class="n">nb_col</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">col_alignments</span><span class="o">=</span><span class="s2">&quot;rlllll&quot;</span><span class="p">,</span>
                    <span class="n">text_size</span><span class="o">=</span><span class="s2">&quot;scriptsize&quot;</span><span class="p">,</span>
                    <span class="n">header_data</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                    <span class="n">tabular_data</span><span class="o">=</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of markers used for IBS analysis</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_markers_ibs</span><span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of unique related samples</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">related_samples</span><span class="p">)))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># The long description</span>
    <span class="n">long_description</span> <span class="o">=</span> <span class="n">find_related_samples</span><span class="o">.</span><span class="n">long_desc</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">ratio</span><span class="o">=</span><span class="s2">&quot;{ratio}&quot;</span><span class="p">,</span>
        <span class="n">ratio_value</span><span class="o">=</span><span class="n">ibs2_ratio</span><span class="p">,</span>
        <span class="n">r_squared</span><span class="o">=</span><span class="n">r2_value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># We know this step doesn&#39;t produce an new data set, so we return the old</span>
    <span class="c1"># prefix and the old in_type</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">find_related_samples</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">long_description</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="n">graphics_paths</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_check_ethnicity"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_check_ethnicity">[docs]</a><span class="k">def</span> <span class="nf">run_check_ethnicity</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step10 (check ethnicity).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the :py:mod:`pyGenClean.Ethnicity.check_ethnicity`</span>
<span class="sd">    module. The required file type for this module is ``bfile``, hence the need</span>
<span class="sd">    to use the :py:func:`check_input_files` to check if the file input file</span>
<span class="sd">    type is the good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The :py:mod:`pyGenClean.Ethnicity.check_ethnicity` module doesn&#39;t</span>
<span class="sd">        return usable output files. Hence, this function returns the input file</span>
<span class="sd">        prefix and its type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;ethnicity&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">check_ethnicity</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">check_ethnicity</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;check_ethnicity: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Getting the multiplier value</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="n">check_ethnicity</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_default</span><span class="p">(</span><span class="s2">&quot;multiplier&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;--multiplier&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">multiplier</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--multiplier&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Getting the population of which the outliers were computed from</span>
    <span class="n">outliers_of</span> <span class="o">=</span> <span class="n">check_ethnicity</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_default</span><span class="p">(</span><span class="s2">&quot;outliers_of&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;--outliers-of&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">outliers_of</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--outliers-of&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Was the reference populations required?</span>
    <span class="n">skip_ref_pops</span> <span class="o">=</span> <span class="s2">&quot;--skip-ref-pops&quot;</span> <span class="ow">in</span> <span class="n">options</span>

    <span class="c1"># Computing the number of outliers</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_ref_pops</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.outliers&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span>
            <span class="p">}</span>

    <span class="c1"># Computing the number of markers used</span>
    <span class="n">nb_markers_mds</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.ibs.pruned_data.bim&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">nb_markers_mds</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="n">graphics_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># TODO: IF THIS CHANGE, code in find_outliers needs to change to...</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">check_ethnicity</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">skip_ref_pops</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Principal components analysis was performed using {:,d} &quot;</span>
                    <span class="s2">&quot;marker{} on the study dataset only.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_markers_mds</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_markers_mds</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Using {:,d} marker{} and a multiplier of {}, there was a &quot;</span>
                    <span class="s2">&quot;total of {:,d} outlier{} of the {} population.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_markers_mds</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_markers_mds</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">multiplier</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">),</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">outliers_of</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># Adding the figure if it exists</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.outliers.png&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
                <span class="c1"># Getting the paths</span>
                <span class="n">graphics_path</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">graphics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span>

                <span class="c1"># Getting the required template</span>
                <span class="n">float_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;float_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">graphic_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;graphics_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># The label</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_outliers&quot;</span>

                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Figure~\ref{&quot;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;} shows the first two &quot;</span>
                    <span class="s2">&quot;principal components of the MDS analysis, where outliers &quot;</span>
                    <span class="s2">&quot;of the &quot;</span> <span class="o">+</span> <span class="n">outliers_of</span> <span class="o">+</span> <span class="s2">&quot; population are shown in grey.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="c1"># Printing</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;MDS plots showing the first two principal components of &quot;</span>
                    <span class="s2">&quot;the source dataset with the reference panels. The &quot;</span>
                    <span class="s2">&quot;outliers of the {} population are shown in grey, while &quot;</span>
                    <span class="s2">&quot;samples of the source dataset that resemble the {} &quot;</span>
                    <span class="s2">&quot;population are shown in orange. A multiplier of {} was &quot;</span>
                    <span class="s2">&quot;used to find the {:,d} outlier{}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">outliers_of</span><span class="p">,</span>
                        <span class="n">outliers_of</span><span class="p">,</span>
                        <span class="n">multiplier</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">),</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">float_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">float_type</span><span class="o">=</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span>
                    <span class="n">float_placement</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">,</span>
                    <span class="n">float_caption</span><span class="o">=</span><span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">caption</span><span class="p">),</span>
                    <span class="n">float_label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">float_content</span><span class="o">=</span><span class="n">graphic_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                        <span class="n">width</span><span class="o">=</span><span class="s2">r&quot;0.8\textwidth&quot;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_fig_name</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Adding the path where the graphic is</span>
                <span class="n">graphics_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">)</span>

            <span class="c1"># Adding the screeplot if it exists</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.smartpca.scree_plot.png&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
                <span class="c1"># Getting the paths</span>
                <span class="n">graphics_path</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">graphics_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span>

                <span class="c1"># Getting the required template</span>
                <span class="n">float_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;float_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">graphic_template</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">jinja2_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span>
                    <span class="s2">&quot;graphics_template.tex&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># The label</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">r&quot;[/</span><span class="se">\\</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_screeplot&quot;</span>

                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">r&quot;Figure~\ref{&quot;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;} shows the scree plot for the &quot;</span>
                    <span class="s2">&quot;principal components of the MDS analysis.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

                <span class="c1"># Printing</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Scree plot for the principal components of the MDS &quot;</span>
                    <span class="s2">&quot;analysis.&quot;</span>
                <span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">float_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">float_type</span><span class="o">=</span><span class="s2">&quot;figure&quot;</span><span class="p">,</span>
                    <span class="n">float_placement</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">,</span>
                    <span class="n">float_caption</span><span class="o">=</span><span class="n">caption</span><span class="p">,</span>
                    <span class="n">float_label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">float_content</span><span class="o">=</span><span class="n">graphic_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                        <span class="n">height</span><span class="o">=</span><span class="s2">r&quot;0.95\textheight&quot;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_fig_name</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Adding the path where the graphic is</span>
                <span class="n">graphics_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">graphics_path</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of markers used for MDS analysis</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_markers_mds</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_ref_pops</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of {} outliers</span><span class="se">\t</span><span class="s2">&quot;</span>
                             <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outliers_of</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">outliers</span><span class="p">)))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step doesn&#39;t produce an new data set, so we return the old</span>
    <span class="c1"># prefix and the old in_type</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">check_ethnicity</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">check_ethnicity</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="n">graphics_paths</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_flag_maf_zero"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_flag_maf_zero">[docs]</a><span class="k">def</span> <span class="nf">run_flag_maf_zero</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step11 (flag MAF zero).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the :py:mod:`pyGenClean.FlagMAF.flag_maf_zero` module.</span>
<span class="sd">    The required file type for this module is ``bfile``, hence the need to use</span>
<span class="sd">    the :py:func:`check_input_files` to check if the file input file type is</span>
<span class="sd">    the good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The :py:mod:`pyGenClean.FlagMAF.flag_maf_zero` module doesn&#39;t return</span>
<span class="sd">        usable output files. Hence, this function returns the input file prefix</span>
<span class="sd">        and its type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;flag_maf_0&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flag_maf_zero</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">flag_maf_zero</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;flag_maf_zero: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Reading the file to compute the number of flagged markers</span>
    <span class="n">nb_flagged</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">flagged_fn</span> <span class="o">=</span> <span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.list&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">flagged_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">nb_flagged</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">flag_maf_zero</span><span class="o">.</span><span class="n">pretty_name</span>
            <span class="p">)</span>
            <span class="n">safe_fn</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">flagged_fn</span><span class="p">))</span>
            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;After computing minor allele frequencies (MAF) of all &quot;</span>
                <span class="s2">&quot;markers using Plink, a total of {:,d} marker{} had a MAF &quot;</span>
                <span class="s2">&quot;of zero and were flagged ({}).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nb_flagged</span><span class="p">,</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_flagged</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;see file &quot;</span> <span class="o">+</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">texttt</span><span class="p">(</span><span class="n">safe_fn</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot; for more information&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Number of markers flagged for MAF of 0</span><span class="se">\t</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nb_flagged</span><span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step doesn&#39;t produce an new data set, so we return the old</span>
    <span class="c1"># prefix and the old in_type</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">flag_maf_zero</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">flag_maf_zero</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_flag_hw"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_flag_hw">[docs]</a><span class="k">def</span> <span class="nf">run_flag_hw</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs step12 (flag HW).</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the :py:mod:`pyGenClean.FlagHW.flag_hw` module. The</span>
<span class="sd">    required file type for this module is ``bfile``, hence the need to use the</span>
<span class="sd">    :py:func:`check_input_files` to check if the file input file type is the</span>
<span class="sd">    good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The :py:mod:`pyGenClean.FlagHW.flag_hw` module doesn&#39;t return usable</span>
<span class="sd">        output files. Hence, this function returns the input file prefix and</span>
<span class="sd">        its type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;flag_hw&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flag_hw</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">flag_hw</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;flag_hw: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Finding the two files containing the list of flagged markers</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.snp_flag_threshold_[0-9]*&quot;</span><span class="p">)</span>
    <span class="n">thresholds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="c1"># Finding the threshold of the file</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="s2">r&quot;^flag_hw.snp_flag_threshold_&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Counting the number of markers in the file</span>
        <span class="n">nb_markers</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">nb_markers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

        <span class="c1"># Saving the values</span>
        <span class="n">thresholds</span><span class="p">[</span><span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nb_markers</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c1"># We create the LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">flag_hw</span><span class="o">.</span><span class="n">pretty_name</span>
            <span class="p">)</span>

            <span class="c1"># Data to write</span>
            <span class="n">sorted_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">thresholds</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

            <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Markers which failed Hardy-Weinberg equilibrium test (using &quot;</span>
                <span class="s2">&quot;Plink) were flagged. A total of {:,d} marker{} failed with a &quot;</span>
                <span class="s2">&quot;threshold of {}. A total of {:,d} marker{} failed with a &quot;</span>
                <span class="s2">&quot;threshold of {}. For a total list, check the files {} and &quot;</span>
                <span class="s2">&quot;{}, respectively.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">thresholds</span><span class="p">[</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">latex_template</span><span class="o">.</span><span class="n">format_numbers</span><span class="p">(</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="n">thresholds</span><span class="p">[</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">latex_template</span><span class="o">.</span><span class="n">format_numbers</span><span class="p">(</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">latex_template</span><span class="o">.</span><span class="n">texttt</span><span class="p">(</span>
                        <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                            <span class="n">thresholds</span><span class="p">[</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="p">)),</span>
                    <span class="p">),</span>
                    <span class="n">latex_template</span><span class="o">.</span><span class="n">texttt</span><span class="p">(</span>
                        <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                            <span class="n">thresholds</span><span class="p">[</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="p">)),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;Number of markers flagged for HW&quot;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;  - {}</span><span class="se">\t</span><span class="s2">{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">sorted_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">thresholds</span><span class="p">[</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;  - {}</span><span class="se">\t</span><span class="s2">{:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">sorted_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">thresholds</span><span class="p">[</span><span class="n">sorted_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># We know this step doesn&#39;t produce an new data set, so we return the old</span>
    <span class="c1"># prefix and the old in_type</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">flag_hw</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">flag_hw</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_compare_gold_standard"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_compare_gold_standard">[docs]</a><span class="k">def</span> <span class="nf">run_compare_gold_standard</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span>
                              <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compares with a gold standard data set (compare_gold_standard.</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the :py:mod:`pyGenClean.Misc.compare_gold_standard`</span>
<span class="sd">    module. The required file type for this module is ``bfile``, hence the need</span>
<span class="sd">    to use the :py:func:`check_input_files` to check if the file input file</span>
<span class="sd">    type is the good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The :py:mod:`pyGenClean.Misc.compare_gold_standard` module doesn&#39;t</span>
<span class="sd">        return usable output files. Hence, this function returns the input file</span>
<span class="sd">        prefix and its type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># We know we need bfile</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;compare_with_gold&quot;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">),</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">script_prefix</span><span class="p">]</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">compare_gold_standard</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">compare_gold_standard</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;compare_gold_standard: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We create the LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span>
                <span class="n">compare_gold_standard</span><span class="o">.</span><span class="n">pretty_name</span>
            <span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># We know this step doesn&#39;t produce an new data set, so we return the old</span>
    <span class="c1"># prefix and the old in_type</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">in_prefix</span><span class="p">,</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">compare_gold_standard</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">compare_gold_standard</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_subset_data"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_subset_data">[docs]</a><span class="k">def</span> <span class="nf">run_subset_data</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subsets the data.</span>

<span class="sd">    :param in_prefix: the prefix of the input files.</span>
<span class="sd">    :param in_type: the type of the input files.</span>
<span class="sd">    :param out_prefix: the output prefix.</span>
<span class="sd">    :param base_dir: the output directory.</span>
<span class="sd">    :param options: the options needed.</span>

<span class="sd">    :type in_prefix: str</span>
<span class="sd">    :type in_type: str</span>
<span class="sd">    :type out_prefix: str</span>
<span class="sd">    :type base_dir: str</span>
<span class="sd">    :type options: list</span>

<span class="sd">    :returns: a tuple containing the prefix of the output files (the input</span>
<span class="sd">              prefix for the next script) and the type of the output files</span>
<span class="sd">              (``bfile``).</span>

<span class="sd">    This function calls the</span>
<span class="sd">    :py:mod:`pyGenClean.pyGenClean.PlinkUtils.subset_data` module. The required</span>
<span class="sd">    file type for this module is ``bfile``, hence the need to use the</span>
<span class="sd">    :py:func:`check_input_files` to check if the file input file type is the</span>
<span class="sd">    good one, or to create it if needed.</span>

<span class="sd">    .. note::</span>
<span class="sd">        The output file type is the same as the input file type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the output directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">)</span>

    <span class="c1"># The prefix of the script</span>
    <span class="n">script_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;subset&quot;</span><span class="p">)</span>

    <span class="c1"># The extension of the marker and sample file</span>
    <span class="n">markers_ext</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">samples_ext</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Looking at what we have</span>
    <span class="n">required_type</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">in_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
        <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>
        <span class="n">markers_ext</span> <span class="o">=</span> <span class="s2">&quot;.bim&quot;</span>
        <span class="n">samples_ext</span> <span class="o">=</span> <span class="s2">&quot;.fam&quot;</span>

    <span class="k">elif</span> <span class="n">in_type</span> <span class="o">==</span> <span class="s2">&quot;tfile&quot;</span><span class="p">:</span>
        <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;tfile&quot;</span>
        <span class="n">markers_ext</span> <span class="o">=</span> <span class="s2">&quot;.tped&quot;</span>
        <span class="n">samples_ext</span> <span class="o">=</span> <span class="s2">&quot;.tfam&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span>
        <span class="n">markers_ext</span> <span class="o">=</span> <span class="s2">&quot;.map&quot;</span>
        <span class="n">samples_ext</span> <span class="o">=</span> <span class="s2">&quot;.ped&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;--is-bfile&quot;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
        <span class="n">required_type</span> <span class="o">=</span> <span class="s2">&quot;bfile&quot;</span>

    <span class="c1"># Checking the input file</span>
    <span class="n">check_input_files</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">,</span> <span class="n">in_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">)</span>

    <span class="c1"># What is going to be done</span>
    <span class="n">is_extract</span> <span class="o">=</span> <span class="s2">&quot;--extract&quot;</span> <span class="ow">in</span> <span class="n">options</span>
    <span class="n">is_exclude</span> <span class="o">=</span> <span class="s2">&quot;--exclude&quot;</span> <span class="ow">in</span> <span class="n">options</span>
    <span class="n">is_keep</span> <span class="o">=</span> <span class="s2">&quot;--keep&quot;</span> <span class="ow">in</span> <span class="n">options</span>
    <span class="n">is_remove</span> <span class="o">=</span> <span class="s2">&quot;--remove&quot;</span> <span class="ow">in</span> <span class="n">options</span>

    <span class="c1"># Checking if we have a reason for markers</span>
    <span class="n">m_subset_reason</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s2">&quot;--reason-marker&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">m_subset_reason</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span>
            <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--reason-marker&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--reason-marker&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_extract</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_exclude</span><span class="p">):</span>
            <span class="c1"># There was a reason for marker exclusion, but no exclusion will be</span>
            <span class="c1"># performed, so we skip in the report</span>
            <span class="n">m_subset_reason</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Checking if we have a reason for samples</span>
    <span class="n">s_subset_reason</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s2">&quot;--reason-sample&quot;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">s_subset_reason</span> <span class="o">=</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">sanitize_tex</span><span class="p">(</span>
            <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--reason-sample&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--reason-sample&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_keep</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_remove</span><span class="p">):</span>
            <span class="c1"># There was a reason for sample exclusion, but no exclusion will be</span>
            <span class="c1"># performed, so we skip in the report</span>
            <span class="n">s_subset_reason</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># We need to inject the name of the input file and the name of the output</span>
    <span class="c1"># prefix</span>
    <span class="n">options</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--ifile&quot;</span><span class="p">,</span> <span class="n">in_prefix</span><span class="p">,</span>
                <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;subset&quot;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">required_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--is-bfile&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">required_type</span> <span class="o">==</span> <span class="s2">&quot;tfile&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--is-tfile&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--is-file&quot;</span><span class="p">)</span>

    <span class="c1"># We run the script</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subset_data</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subset_data</span><span class="o">.</span><span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;subset_data: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># The files before the subset</span>
    <span class="n">samples_before_fn</span> <span class="o">=</span> <span class="n">in_prefix</span>
    <span class="n">markers_before_fn</span> <span class="o">=</span> <span class="n">in_prefix</span>

    <span class="c1"># The files after the subset</span>
    <span class="n">samples_after_fn</span> <span class="o">=</span> <span class="n">script_prefix</span>
    <span class="n">markers_after_fn</span> <span class="o">=</span> <span class="n">script_prefix</span>

    <span class="c1"># The name of the subset file for markers and samples</span>
    <span class="n">sample_subset_fn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">marker_subset_fn</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># The samples and markers that were removed</span>
    <span class="n">removed_samples</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">removed_markers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># The set of samples and markers before subset</span>
    <span class="n">samples_before</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">markers_before</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># The set of remaining samples and markers after subset</span>
    <span class="n">samples_after</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">markers_after</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Markers were extracted</span>
    <span class="n">nb_extract</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">is_extract</span><span class="p">:</span>
        <span class="c1"># Counting the number of markers that were extracted</span>
        <span class="n">marker_subset_fn</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--extract&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">marker_subset_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">nb_extract</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">)</span>

    <span class="c1"># Markers were excluded</span>
    <span class="n">nb_exclude</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">is_exclude</span><span class="p">:</span>
        <span class="n">marker_subset_fn</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--exclude&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">marker_subset_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">nb_exclude</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">)</span>

    <span class="c1"># Checking the difference between both (for markers)</span>
    <span class="k">if</span> <span class="n">is_extract</span> <span class="ow">or</span> <span class="n">is_exclude</span><span class="p">:</span>
        <span class="n">markers_before_fn</span> <span class="o">+=</span> <span class="n">markers_ext</span>
        <span class="n">markers_after_fn</span> <span class="o">+=</span> <span class="s2">&quot;.bim&quot;</span> <span class="k">if</span> <span class="n">required_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span> <span class="k">else</span> <span class="n">markers_ext</span>

        <span class="n">markers_before</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">markers_before_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">markers_before</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span>
            <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">markers_after_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">markers_after</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span>
            <span class="p">}</span>

        <span class="n">reason</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">marker_subset_fn</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m_subset_reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="n">m_subset_reason</span>
        <span class="n">removed_markers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;subset {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">markers_before</span> <span class="o">-</span> <span class="n">markers_after</span>
        <span class="p">}</span>

    <span class="c1"># Samples were kept</span>
    <span class="n">nb_keep</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">is_keep</span><span class="p">:</span>
        <span class="n">sample_subset_fn</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--keep&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_subset_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">nb_keep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">)</span>

    <span class="c1"># Samples were removed</span>
    <span class="n">nb_remove</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">is_remove</span><span class="p">:</span>
        <span class="n">sample_subset_fn</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">options</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;--remove&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_subset_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">nb_remove</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_keep</span> <span class="ow">or</span> <span class="n">is_remove</span><span class="p">:</span>
        <span class="n">samples_before_fn</span> <span class="o">+=</span> <span class="n">samples_ext</span>
        <span class="n">samples_after_fn</span> <span class="o">+=</span> <span class="s2">&quot;.fam&quot;</span> <span class="k">if</span> <span class="n">required_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span> <span class="k">else</span> <span class="n">samples_ext</span>

        <span class="n">samples_before</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">samples_before_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">samples_before</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">line</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span>
            <span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">samples_after_fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
            <span class="n">samples_after</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">createRowFromPlinkSpacedOutput</span><span class="p">(</span><span class="n">line</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_file</span>
            <span class="p">}</span>

        <span class="n">reason</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">sample_subset_fn</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s_subset_reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="n">s_subset_reason</span>
        <span class="n">removed_samples</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">):</span> <span class="s2">&quot;subset {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">samples_before</span> <span class="o">-</span> <span class="n">samples_after</span>
        <span class="p">}</span>

    <span class="c1"># Reading the log file to gather what is left</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_file</span><span class="p">:</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">i_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Checking the number of markers at the beginning</span>
    <span class="n">nb_marker_start</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="s2">r&quot;(\d+) (\(of \d+\) )?markers to be included &quot;</span>
        <span class="s2">&quot;from \[ {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">),</span>
        <span class="n">log_file</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_marker_start</span><span class="p">:</span>
        <span class="n">nb_marker_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_marker_start</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Checking the number of markers at the end</span>
    <span class="n">nb_marker_end</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="s2">r&quot;Before frequency and genotyping pruning, there are (\d+) SNPs&quot;</span><span class="p">,</span>
        <span class="n">log_file</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_marker_end</span><span class="p">:</span>
        <span class="n">nb_marker_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_marker_end</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Checking the number of samples</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">markers_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nb_marker_end</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markers_after</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="s2">&quot;Something went wrong with Plink&#39;s subset (numbers &quot;</span>
                           <span class="s2">&quot;are different from data and log file)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_marker_start</span> <span class="o">-</span> <span class="n">nb_marker_end</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_markers</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="s2">&quot;Something went wrong with Plink&#39;s subset (numbers &quot;</span>
                           <span class="s2">&quot;are different from data and log file)&quot;</span><span class="p">)</span>

    <span class="c1"># Checking the number of samples at the beginning</span>
    <span class="n">nb_sample_start</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="s2">r&quot;(\d+) individuals read from \[ {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_prefix</span><span class="p">),</span>
        <span class="n">log_file</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_sample_start</span><span class="p">:</span>
        <span class="n">nb_sample_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_sample_start</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Checking the number of samples at the end</span>
    <span class="n">nb_sample_end</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="s2">r&quot;(\d+) founders and (\d+) non-founders found&quot;</span><span class="p">,</span>
        <span class="n">log_file</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_sample_end</span><span class="p">:</span>
        <span class="n">nb_sample_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_sample_end</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> \
                        <span class="nb">int</span><span class="p">(</span><span class="n">nb_sample_end</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Checking the number of samples</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">samples_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nb_sample_end</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples_after</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="s2">&quot;Something went wrong with Plink&#39;s subset (numbers &quot;</span>
                           <span class="s2">&quot;are different from data and log file)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_sample_start</span> <span class="o">-</span> <span class="n">nb_sample_end</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_samples</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="s2">&quot;Something went wrong with Plink&#39;s subset (numbers &quot;</span>
                           <span class="s2">&quot;are different from data and log file)&quot;</span><span class="p">)</span>

    <span class="c1"># Creating the reasons</span>
    <span class="n">reasons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m_subset_reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_subset_reason</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s_subset_reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_subset_reason</span><span class="p">)</span>

    <span class="c1"># We write a LaTeX summary</span>
    <span class="n">latex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_prefix</span> <span class="o">+</span> <span class="s2">&quot;.summary.tex&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">latex_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">section_name</span> <span class="o">=</span> <span class="n">subset_data</span><span class="o">.</span><span class="n">pretty_name</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">section_name</span> <span class="o">+=</span> <span class="s2">&quot; ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reasons</span><span class="p">))</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">subsection</span><span class="p">(</span><span class="n">section_name</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">is_extract</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot;The file for marker extraction contained {:,d} marker{}. &quot;</span>
                    <span class="s2">&quot;Out of a total of {:,d} marker{}, {:,d} &quot;</span>
                    <span class="s2">&quot;remained ({:,d} excluded).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_extract</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_extract</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_marker_start</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_marker_start</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_marker_end</span><span class="p">,</span>
                        <span class="n">nb_marker_start</span> <span class="o">-</span> <span class="n">nb_marker_end</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_exclude</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot;The file for marker exclusion contained {:,d} marker{}. &quot;</span>
                    <span class="s2">&quot;Out of a total of {:,d} marker{}, {:,d} &quot;</span>
                    <span class="s2">&quot;remained ({:,d} excluded). &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_exclude</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_exclude</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_marker_start</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_marker_start</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_marker_end</span><span class="p">,</span>
                        <span class="n">nb_marker_start</span> <span class="o">-</span> <span class="n">nb_marker_end</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_keep</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot;The file containing samples to keep contained {:,d} &quot;</span>
                    <span class="s2">&quot;sample{}. Out of a total of {:,d} sample{}, {:,d} &quot;</span>
                    <span class="s2">&quot;remained ({:,d} removed). &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_keep</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_keep</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_sample_start</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_sample_start</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_sample_end</span><span class="p">,</span>
                        <span class="n">nb_sample_start</span> <span class="o">-</span> <span class="n">nb_sample_end</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_remove</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot;The file containing samples to remove contained {:,d} &quot;</span>
                    <span class="s2">&quot;sample{}. Out of a total of {:,d} sample{}, {:,d} &quot;</span>
                    <span class="s2">&quot;remained ({:,d} removed). &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">nb_remove</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_remove</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_sample_start</span><span class="p">,</span>
                        <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">nb_sample_start</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">nb_sample_end</span><span class="p">,</span>
                        <span class="n">nb_sample_start</span> <span class="o">-</span> <span class="n">nb_sample_end</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="n">latex_template</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: cannot write LaTeX summary&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Writing the excluded samples</span>
    <span class="n">o_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;excluded_samples.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">o_filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">removed_samples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Writing the excluded markers to file</span>
    <span class="n">o_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;excluded_markers.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">o_filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">removed_markers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Writing the summary results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;results_summary.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;# {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nb_marker_end</span> <span class="o">!=</span> <span class="n">nb_marker_start</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;_file_path:&quot;</span> <span class="o">+</span> <span class="n">marker_subset_fn</span>
            <span class="k">if</span> <span class="n">m_subset_reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">m_subset_reason</span>

            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;Number of markers excluded&quot;</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;  - {reason}</span><span class="se">\t</span><span class="s2">{nb:,d}</span><span class="se">\t</span><span class="s2">-{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
                <span class="n">nb</span><span class="o">=</span><span class="n">nb_marker_start</span> <span class="o">-</span> <span class="n">nb_marker_end</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>
        <span class="k">if</span> <span class="n">nb_sample_end</span> <span class="o">!=</span> <span class="n">nb_sample_start</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;_file_path:&quot;</span> <span class="o">+</span> <span class="n">sample_subset_fn</span>
            <span class="k">if</span> <span class="n">s_subset_reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">s_subset_reason</span>

            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;Number of samples removed&quot;</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;  - {reason}</span><span class="se">\t</span><span class="s2">{nb:,d}</span><span class="se">\t\t</span><span class="s2">-{nb:,d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
                <span class="n">nb</span><span class="o">=</span><span class="n">nb_sample_start</span> <span class="o">-</span> <span class="n">nb_sample_end</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">o_file</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span>

    <span class="c1"># Modifying the description</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">subset_data</span><span class="o">.</span><span class="n">desc</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">+=</span> <span class="s2">&quot; ({})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reasons</span><span class="p">))</span>

    <span class="c1"># We know this step does produce a new data set (bfile), so we return it</span>
    <span class="k">return</span> <span class="n">_StepResult</span><span class="p">(</span>
        <span class="n">next_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_prefix</span><span class="p">,</span> <span class="s2">&quot;subset&quot;</span><span class="p">),</span>
        <span class="n">next_file_type</span><span class="o">=</span><span class="n">required_type</span><span class="p">,</span>
        <span class="n">latex_summary</span><span class="o">=</span><span class="n">latex_file</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="n">long_description</span><span class="o">=</span><span class="n">subset_data</span><span class="o">.</span><span class="n">long_desc</span><span class="p">,</span>
        <span class="n">graph_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="run_command"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.run_command">[docs]</a><span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a command using subprocesses.</span>

<span class="sd">    :param command: the command to run.</span>

<span class="sd">    :type command: list</span>

<span class="sd">    Tries to run a command. If it fails, raise a :py:class:`ProgramError`.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        The variable ``command`` should be a list of strings (no other type).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                                         <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;couldn&#39;t run command</span><span class="se">\n</span><span class="s2">{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="count_markers_samples"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.count_markers_samples">[docs]</a><span class="k">def</span> <span class="nf">count_markers_samples</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">file_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Counts the number of markers and samples in plink file.</span>

<span class="sd">    :param prefix: the prefix of the files.</span>
<span class="sd">    :param file_type: the file type.</span>

<span class="sd">    :type prefix: str</span>
<span class="sd">    :type file_type: str</span>

<span class="sd">    :returns: the number of markers and samples (in a tuple).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The files that will need counting</span>
    <span class="n">sample_file</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">marker_file</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
        <span class="c1"># Binary files (.bed, .bim and .fam)</span>
        <span class="n">sample_file</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.fam&quot;</span>
        <span class="n">marker_file</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.bim&quot;</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
        <span class="c1"># Pedfile (.ped and .map)</span>
        <span class="n">sample_file</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.ped&quot;</span>
        <span class="n">marker_file</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.map&quot;</span>

    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;tfile&quot;</span><span class="p">:</span>
        <span class="c1"># Transposed pedfile (.tped and .tfam)</span>
        <span class="n">sample_file</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.tfam&quot;</span>
        <span class="n">marker_file</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.tped&quot;</span>

    <span class="c1"># Counting (this may take some time)</span>
    <span class="n">nb_samples</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nb_samples</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">nb_markers</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">marker_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nb_markers</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">nb_markers</span><span class="p">,</span> <span class="n">nb_samples</span></div>


<div class="viewcode-block" id="check_input_files"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.check_input_files">[docs]</a><span class="k">def</span> <span class="nf">check_input_files</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">the_type</span><span class="p">,</span> <span class="n">required_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that the file is of a certain file type.</span>

<span class="sd">    :param prefix: the prefix of the input files.</span>
<span class="sd">    :param the_type: the type of the input files (bfile, tfile or file).</span>
<span class="sd">    :param required_type: the required type of the input files (bfile, tfile or</span>
<span class="sd">                          file).</span>

<span class="sd">    :type prefix: str</span>
<span class="sd">    :type the_type: str</span>
<span class="sd">    :type required_type: str</span>

<span class="sd">    :returns: ``True`` if everything is OK.</span>

<span class="sd">    Checks if the files are of the required type, according to their current</span>
<span class="sd">    type. The available types are ``bfile`` (binary), ``tfile`` (transposed)</span>
<span class="sd">    and ``file`` (normal).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The files required for each type</span>
    <span class="n">bfile_type</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.bed&quot;</span><span class="p">,</span> <span class="s2">&quot;.bim&quot;</span><span class="p">,</span> <span class="s2">&quot;.fam&quot;</span><span class="p">}</span>
    <span class="n">tfile_type</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.tped&quot;</span><span class="p">,</span> <span class="s2">&quot;.tfam&quot;</span><span class="p">}</span>
    <span class="n">file_type</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.ped&quot;</span><span class="p">,</span> <span class="s2">&quot;.map&quot;</span><span class="p">}</span>

    <span class="c1"># Check if of bfile, tfile and file</span>
    <span class="n">plink_command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plink&quot;</span><span class="p">,</span> <span class="s2">&quot;--noweb&quot;</span><span class="p">,</span> <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">required_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
        <span class="c1"># We need bfile</span>
        <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--make-bed&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;tfile&quot;</span><span class="p">:</span>
            <span class="c1"># We have tfile, we need to create bfile from tfile</span>
            <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--tfile&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="c1"># We have file, we need to create bfile from file</span>
            <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no suitable input format...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># We create the required files</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">):</span>
            <span class="c1"># There is a log file... we need to copy it</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.olog&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting {} from {} to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="n">the_type</span><span class="p">,</span>
            <span class="n">required_type</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="n">run_command</span><span class="p">(</span><span class="n">plink_command</span><span class="p">)</span>

        <span class="c1"># Everything is now fine</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">elif</span> <span class="n">required_type</span> <span class="o">==</span> <span class="s2">&quot;tfile&quot;</span><span class="p">:</span>
        <span class="c1"># We need a tfile</span>
        <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--recode&quot;</span><span class="p">,</span> <span class="s2">&quot;--transpose&quot;</span><span class="p">,</span> <span class="s2">&quot;--tab&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;tfile&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
            <span class="c1"># We have bfile, we need to create tfile from bfile</span>
            <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--bfile&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="c1"># We have file, we need to create tfile from file</span>
            <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no suitable input format...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># We create the required files</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">):</span>
            <span class="c1"># There is a log file... we need to copy it</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.olog&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting {} from {} to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="n">the_type</span><span class="p">,</span>
            <span class="n">required_type</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="n">run_command</span><span class="p">(</span><span class="n">plink_command</span><span class="p">)</span>

        <span class="c1"># Everything is now fine</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">elif</span> <span class="n">required_type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
        <span class="c1"># We need a file</span>
        <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--recode&quot;</span><span class="p">,</span> <span class="s2">&quot;--tab&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;bfile&quot;</span><span class="p">:</span>
            <span class="c1"># We have bfile, we need to create file from bfile</span>
            <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--bfile&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">the_type</span> <span class="o">==</span> <span class="s2">&quot;tfile&quot;</span><span class="p">:</span>
            <span class="c1"># We have tfile, we need to create file from tfile</span>
            <span class="n">plink_command</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--tfile&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no suitable input format...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># We create the required files</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">):</span>
            <span class="c1"># There is a log file... we need to copy it</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.olog&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting {} from {} to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="n">the_type</span><span class="p">,</span>
            <span class="n">required_type</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="n">run_command</span><span class="p">(</span><span class="n">plink_command</span><span class="p">)</span>

        <span class="c1"># Everything is now fine</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: unknown file format&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">required_type</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="all_files_exist"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.all_files_exist">[docs]</a><span class="k">def</span> <span class="nf">all_files_exist</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if all files exist.</span>

<span class="sd">    :param file_list: the names of files to check.</span>

<span class="sd">    :type file_list: list</span>

<span class="sd">    :returns: ``True`` if all files exist, ``False`` otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_exist</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">all_exist</span> <span class="o">=</span> <span class="n">all_exist</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_exist</span></div>


<div class="viewcode-block" id="read_config_file"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.read_config_file">[docs]</a><span class="k">def</span> <span class="nf">read_config_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads the configuration file.</span>

<span class="sd">    :param filename: the name of the file containing the configuration.</span>

<span class="sd">    :type filename: str</span>

<span class="sd">    :returns: A tuple where the first element is a list of sections, and the</span>
<span class="sd">              second element is a map containing the configuration (options and</span>
<span class="sd">              values).</span>

<span class="sd">    The structure of the configuration file is important. Here is an example of</span>
<span class="sd">    a configuration file::</span>

<span class="sd">        [1] # Computes statistics on duplicated samples</span>
<span class="sd">        script = duplicated_samples</span>

<span class="sd">        [2] # Removes samples according to missingness</span>
<span class="sd">        script = sample_missingness</span>

<span class="sd">        [3] # Removes markers according to missingness</span>
<span class="sd">        script = snp_missingness</span>

<span class="sd">        [4] # Removes samples according to missingness (98%)</span>
<span class="sd">        script = sample_missingness</span>
<span class="sd">        mind = 0.02</span>

<span class="sd">        [5] # Performs a sex check</span>
<span class="sd">        script = sex_check</span>

<span class="sd">        [6] # Flags markers with MAF=0</span>
<span class="sd">        script = flag_maf_zero</span>

<span class="sd">        [7] # Flags markers according to Hardy Weinberg</span>
<span class="sd">        script = flag_hw</span>

<span class="sd">        [8] # Subset the dataset (excludes markers and remove samples)</span>
<span class="sd">        script = subset</span>
<span class="sd">        exclude = .../filename</span>
<span class="sd">        rempove = .../filename</span>

<span class="sd">    Sections are in square brackets and must be ``integer``. The section number</span>
<span class="sd">    represent the step at which the script will be run (*i.e.* from the</span>
<span class="sd">    smallest number to the biggest). The sections must be continuous.</span>

<span class="sd">    Each section contains the script names (``script`` variable) and options of</span>
<span class="sd">    the script (all other variables) (*e.g.* section 4 runs the</span>
<span class="sd">    ``sample_missingness`` script (:py:func:`run_sample_missingness`) with</span>
<span class="sd">    option ``mind`` sets to 0.02).</span>

<span class="sd">    Here is a list of the available scripts:</span>

<span class="sd">    * ``duplicated_samples`` (:py:func:`run_duplicated_samples`)</span>
<span class="sd">    * ``duplicated_snps`` (:py:func:`run_duplicated_snps`)</span>
<span class="sd">    * ``noCall_hetero_snps`` (:py:func:`run_noCall_hetero_snps`)</span>
<span class="sd">    * ``sample_missingness`` (:py:func:`run_sample_missingness`)</span>
<span class="sd">    * ``snp_missingness`` (:py:func:`run_snp_missingness`)</span>
<span class="sd">    * ``sex_check`` (:py:func:`run_sex_check`)</span>
<span class="sd">    * ``plate_bias`` (:py:func:`run_plate_bias`)</span>
<span class="sd">    * ``contamination`` (:py:func:`run_contamination`)</span>
<span class="sd">    * ``remove_heterozygous_haploid``</span>
<span class="sd">      (:py:func:`run_remove_heterozygous_haploid`)</span>
<span class="sd">    * ``find_related_samples`` (:py:func:`run_find_related_samples`)</span>
<span class="sd">    * ``check_ethnicity`` (:py:func:`run_check_ethnicity`)</span>
<span class="sd">    * ``flag_maf_zero`` (:py:func:`run_flag_maf_zero`)</span>
<span class="sd">    * ``flag_hw`` (:py:func:`run_flag_hw`)</span>
<span class="sd">    * ``subset`` (:py:func:`run_subset_data`)</span>
<span class="sd">    * ``compare_gold_standard`` (:py:func:`run_compare_gold_standard`)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Creating the config parser</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">(</span><span class="n">allow_no_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Checking the section names</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># Section not integer</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;{}: sections must be integers: &quot;</span>
               <span class="s2">&quot;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()))</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sections</span> <span class="o">!=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">sections</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Missing a section</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: maybe a section is missing: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">]</span>

    <span class="c1"># Reading the configuration for each sections</span>
    <span class="n">configuration</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
        <span class="c1"># Getting the script variable (and check it)</span>
        <span class="n">script_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">script_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;script&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">NoOptionError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;{}: section {}: no variable called &#39;script&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span>
                <span class="n">section</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">script_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_modules</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;{}: section {}: script {}: invalid script name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">filename</span><span class="p">,</span>
                <span class="n">section</span><span class="p">,</span>
                <span class="n">script_name</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Getting the variables</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">variable_value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
            <span class="n">unwanted_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bfile&quot;</span><span class="p">,</span> <span class="s2">&quot;tfile&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">script_name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;sample_missingness&quot;</span><span class="p">,</span> <span class="s2">&quot;subset&quot;</span><span class="p">}:</span>
                <span class="n">unwanted_options</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;ifile&quot;</span><span class="p">,</span> <span class="s2">&quot;is-bfile&quot;</span><span class="p">,</span> <span class="s2">&quot;is-tfile&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">script_name</span> <span class="o">==</span> <span class="s2">&quot;subset&quot;</span><span class="p">:</span>
                <span class="n">unwanted_options</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;is-file&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">unwanted</span> <span class="ow">in</span> <span class="n">unwanted_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">variable_name</span> <span class="o">==</span> <span class="n">unwanted</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;{}: section {}: do not use {} as an option for &quot;</span>
                           <span class="s2">&quot;{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">unwanted</span><span class="p">,</span>
                                       <span class="n">script_name</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">variable_name</span> <span class="o">!=</span> <span class="s2">&quot;script&quot;</span><span class="p">:</span>
                <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">variable_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">variable_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;indep-pairwise&quot;</span><span class="p">,</span> <span class="s2">&quot;sge-nodes&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;ibs-sge-nodes&quot;</span><span class="p">}:</span>
                        <span class="c1"># This is a special option</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">variable_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable_value</span><span class="p">)</span>

        <span class="c1"># Saving the configuration</span>
        <span class="n">configuration</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">script_name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sections</span><span class="p">,</span> <span class="n">configuration</span></div>


<div class="viewcode-block" id="check_args"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.check_args">[docs]</a><span class="k">def</span> <span class="nf">check_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks the arguments and options.</span>

<span class="sd">    :param args: an object containing the options and arguments of the program.</span>

<span class="sd">    :type args: :py:class:`argparse.Namespace`</span>

<span class="sd">    :returns: ``True`` if everything was OK.</span>

<span class="sd">    If there is a problem with an option, an exception is raised using the</span>
<span class="sd">    :py:class:`ProgramError` class, a message is printed to the</span>
<span class="sd">    :class:`sys.stderr` and the program exits with error code 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Checking the configuration file</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">conf</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no such file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Check the input files</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">bfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">tfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;needs one input file prefix (--bfile, --tfile or --file)&quot;</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">bfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">tfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">bfile</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.bed&quot;</span><span class="p">,</span> <span class="s2">&quot;.bim&quot;</span><span class="p">,</span> <span class="s2">&quot;.fam&quot;</span><span class="p">]]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no such file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">tfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">bfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">tfile</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.tped&quot;</span><span class="p">,</span> <span class="s2">&quot;.tfam&quot;</span><span class="p">]]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no such file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">bfile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">tfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.ped&quot;</span><span class="p">,</span> <span class="s2">&quot;.map&quot;</span><span class="p">]]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;{}: no such file&quot;</span><span class="o">.</span> <span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;needs only one input file prefix (--bfile, --tfile or --file)&quot;</span>
        <span class="k">raise</span> <span class="n">ProgramError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">True</span></div>


<div class="viewcode-block" id="parse_args"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.parse_args">[docs]</a><span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Parses the command line options and arguments.</span>

<span class="sd">    :returns: A :py:class:`argparse.Namespace` object created by the</span>
<span class="sd">              :py:mod:`argparse` module. It contains the values of the</span>
<span class="sd">              different options.</span>

<span class="sd">    ======================= =======  ==========================================</span>
<span class="sd">             Options         Type                      Description</span>
<span class="sd">    ======================= =======  ==========================================</span>
<span class="sd">    ``--bfile``             String   The input binary file prefix from Plink.</span>
<span class="sd">    ``--tfile``             String   The input transposed file prefix from</span>
<span class="sd">                                     Plink.</span>
<span class="sd">    ``--file``              String   The input file prefix from Plink.</span>
<span class="sd">    ``--conf``              String   The parameter file for the data clean up.</span>
<span class="sd">    ``--report-author``     String   The current project number.</span>
<span class="sd">    ``--report-number``     String   The current project author.</span>
<span class="sd">    ``--report-background`` String   Text of file containing the background</span>
<span class="sd">                                     section of the report.</span>
<span class="sd">    ======================= =======  ==========================================</span>

<span class="sd">    .. note::</span>
<span class="sd">        No option check is done here (except for the one automatically done by</span>
<span class="sd">        :py:mod:`argparse`). Those need to be done elsewhere (see</span>
<span class="sd">        :py:func:`checkArgs`).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>


<span class="c1"># The parser object</span>
<span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Runs the data clean up (pyGenClean version {}).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span>
                    <span class="n">version</span><span class="o">=</span><span class="s2">&quot;pyGenClean version {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">))</span>

<span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;Input File&quot;</span><span class="p">)</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--bfile&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;The input file prefix (will find the plink &quot;</span>
                         <span class="s2">&quot;binary files by appending the prefix to the &quot;</span>
                         <span class="s2">&quot;.bim, .bed and .fam files, respectively).&quot;</span><span class="p">))</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--tfile&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;The input file prefix (will find the plink &quot;</span>
                         <span class="s2">&quot;transposed files by appending the prefix to the &quot;</span>
                         <span class="s2">&quot;.tped and .tfam files, respectively).&quot;</span><span class="p">))</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;The input file prefix (will find the plink &quot;</span>
                         <span class="s2">&quot;files by appending the prefix to the &quot;</span>
                         <span class="s2">&quot;.ped and .fam files).&quot;</span><span class="p">))</span>

<span class="c1"># The options</span>
<span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;Report Options&quot;</span><span class="p">)</span>
<span class="n">report_options</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

<span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;Configuration File&quot;</span><span class="p">)</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--conf&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The parameter file for the data clean up.&quot;</span><span class="p">)</span>


<span class="c1"># The available modules</span>
<span class="n">available_modules</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;duplicated_samples&quot;</span><span class="p">:</span> <span class="n">duplicated_samples</span><span class="p">,</span>
    <span class="s2">&quot;duplicated_snps&quot;</span><span class="p">:</span> <span class="n">duplicated_snps</span><span class="p">,</span>
    <span class="s2">&quot;noCall_hetero_snps&quot;</span><span class="p">:</span> <span class="n">noCall_hetero_snps</span><span class="p">,</span>
    <span class="s2">&quot;sample_missingness&quot;</span><span class="p">:</span> <span class="n">sample_missingness</span><span class="p">,</span>
    <span class="s2">&quot;snp_missingness&quot;</span><span class="p">:</span> <span class="n">snp_missingness</span><span class="p">,</span>
    <span class="s2">&quot;sex_check&quot;</span><span class="p">:</span> <span class="n">sex_check</span><span class="p">,</span>
    <span class="s2">&quot;plate_bias&quot;</span><span class="p">:</span> <span class="n">plate_bias</span><span class="p">,</span>
    <span class="s2">&quot;remove_heterozygous_haploid&quot;</span><span class="p">:</span> <span class="n">remove_heterozygous_haploid</span><span class="p">,</span>
    <span class="s2">&quot;find_related_samples&quot;</span><span class="p">:</span> <span class="n">find_related_samples</span><span class="p">,</span>
    <span class="s2">&quot;check_ethnicity&quot;</span><span class="p">:</span> <span class="n">check_ethnicity</span><span class="p">,</span>
    <span class="s2">&quot;contamination&quot;</span><span class="p">:</span> <span class="n">contamination</span><span class="p">,</span>
    <span class="s2">&quot;flag_maf_zero&quot;</span><span class="p">:</span> <span class="n">flag_maf_zero</span><span class="p">,</span>
    <span class="s2">&quot;flag_hw&quot;</span><span class="p">:</span> <span class="n">flag_hw</span><span class="p">,</span>
    <span class="s2">&quot;subset&quot;</span><span class="p">:</span> <span class="n">subset_data</span><span class="p">,</span>
    <span class="s2">&quot;compare_gold_standard&quot;</span><span class="p">:</span> <span class="n">compare_gold_standard</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">available_functions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;duplicated_samples&quot;</span><span class="p">:</span> <span class="n">run_duplicated_samples</span><span class="p">,</span>
    <span class="s2">&quot;duplicated_snps&quot;</span><span class="p">:</span> <span class="n">run_duplicated_snps</span><span class="p">,</span>
    <span class="s2">&quot;noCall_hetero_snps&quot;</span><span class="p">:</span> <span class="n">run_noCall_hetero_snps</span><span class="p">,</span>
    <span class="s2">&quot;sample_missingness&quot;</span><span class="p">:</span> <span class="n">run_sample_missingness</span><span class="p">,</span>
    <span class="s2">&quot;snp_missingness&quot;</span><span class="p">:</span> <span class="n">run_snp_missingness</span><span class="p">,</span>
    <span class="s2">&quot;sex_check&quot;</span><span class="p">:</span> <span class="n">run_sex_check</span><span class="p">,</span>
    <span class="s2">&quot;plate_bias&quot;</span><span class="p">:</span> <span class="n">run_plate_bias</span><span class="p">,</span>
    <span class="s2">&quot;remove_heterozygous_haploid&quot;</span><span class="p">:</span> <span class="n">run_remove_heterozygous_haploid</span><span class="p">,</span>
    <span class="s2">&quot;find_related_samples&quot;</span><span class="p">:</span> <span class="n">run_find_related_samples</span><span class="p">,</span>
    <span class="s2">&quot;check_ethnicity&quot;</span><span class="p">:</span> <span class="n">run_check_ethnicity</span><span class="p">,</span>
    <span class="s2">&quot;contamination&quot;</span><span class="p">:</span> <span class="n">run_contamination</span><span class="p">,</span>
    <span class="s2">&quot;flag_maf_zero&quot;</span><span class="p">:</span> <span class="n">run_flag_maf_zero</span><span class="p">,</span>
    <span class="s2">&quot;flag_hw&quot;</span><span class="p">:</span> <span class="n">run_flag_hw</span><span class="p">,</span>
    <span class="s2">&quot;subset&quot;</span><span class="p">:</span> <span class="n">run_subset_data</span><span class="p">,</span>
    <span class="s2">&quot;compare_gold_standard&quot;</span><span class="p">:</span> <span class="n">run_compare_gold_standard</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="safe_main"><a class="viewcode-back" href="../../module_content/pyGenClean.html#pyGenClean.run_data_clean_up.safe_main">[docs]</a><span class="k">def</span> <span class="nf">safe_main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A safe version of the main function (that catches ProgramError).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cancelled by user&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ProgramError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">safe_main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyGenClean 1.8.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../pyGenClean.html" >pyGenClean</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2012, Louis-Philippe Lemieux Perreault.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>